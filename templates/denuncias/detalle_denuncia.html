{% extends "partials/sidebar.html" %}
{% block title %} Detalle de Denuncia {% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<style>
  :root {
    --bg-color: #f4f6f8;
    --card-color: #ffffff;
    --accent-color: #fbc02d;
    --text-color: #333;
    --border-radius: 16px;
  }

  body {
    background-color: var(--bg-color);
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    color: var(--text-color);
  }

  .container {
    max-width: 900px;
    margin: 1rem auto;
    padding: 0.2rem;
  }

  .title {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 2rem;
    color: #222;
  }

  .card {
    background-color: var(--card-color);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  }

  .card h4 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .badge {
    background-color: var(--accent-color);
    color: #000;
    font-weight: bold;
    padding: 0.3rem 0.6rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
  }

  .info p {
    margin: 0.4rem 0;
    font-size: 0.95rem;
  }

  .media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    
  }

  .media-grid img,
  .media-grid video {
    width: 100%;
    border-radius: 10px;
  }

  audio {
    width: 100%;
    margin-top: 0.5rem;
  }

  .section-title {
    font-size: 1.1rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    font-weight: bold;
  }

  #map {
    height: 300px;
    border-radius: 12px;
    margin-top: 2rem;
  }

  @media (max-width: 600px) {
    .card {
      padding: 1.2rem;
    }
  }
</style>

<div class="container">
  <h2 class="title"><i class="fas fa-bullhorn"></i> Detalle de Denuncia</h2>
  <div id="denuncia-container"></div>
  <div id="map"></div>

  {% if vision %}
  <!-- Botones Aceptar / Rechazar -->
  <div id="action-buttons" style="margin-top: 1.5rem; text-align: center;">
    <button id="btn-aceptar" class="btn btn-success"
      style="margin-right: 1rem; padding: 0.5rem 1.5rem; font-size: 1rem;">
      <i class="fas fa-check"></i> Aceptar
    </button>
    <button id="btn-rechazar" class="btn btn-danger" style="padding: 0.5rem 1.5rem; font-size: 1rem;">
      <i class="fas fa-times"></i> Rechazar
    </button>
  </div>
  {% endif %}
</div>

<!-- Modal -->
<div id="modal-accion" style="
  display: none; 
  position: fixed; 
  top: 0; left: 0; right: 0; bottom: 0; 
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center; 
  align-items: center;
">
  <div style="
    background: white; 
    border-radius: 12px; 
    padding: 2rem; 
    max-width: 500px; 
    width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    position: relative;
  ">
    <h3 id="modal-titulo">Confirmar acción</h3>
    <form id="form-accion">
      <label for="descripcion" style="font-weight: bold; margin-top: 1rem; display: block;">Descripción</label>
      <textarea id="descripcion" name="descripcion" rows="4" style="width: 100%; padding: 0.5rem; margin-top: 0.3rem;"
        required></textarea>

      <label for="archivo" style="font-weight: bold; margin-top: 1rem; display: block;">Adjuntar archivo</label>
      <input type="file" id="archivo" name="archivo" style="margin-top: 0.3rem;" />

      <div style="margin-top: 1.5rem; text-align: right;">
        <button type="button" id="btn-cerrar-modal" style="margin-right: 1rem; padding: 0.5rem 1rem;">Cancelar</button>
        <button type="submit"
          style="padding: 0.5rem 1.2rem; background-color: var(--accent-color); border: none; border-radius: 6px; cursor: pointer;">
          Enviar
        </button>
      </div>
    </form>
  </div>
</div>






<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const container = document.getElementById("denuncia-container");
  const mapElement = document.getElementById("map");

  fetch("{{ BASE_URL }}/api/central/denuncias/detalle/{{ id }}")
    .then(res => res.json())
    .then(data => {
      const d = data.denuncia;

      let lat = 0, lng = 0;
      if (d.ubicacion && d.ubicacion.includes(",")) {
        [lat, lng] = d.ubicacion.split(',').map(coord => parseFloat(coord.trim()));
      }

      const template = `
          <div class="card">
            <h4>${d.denuncia_nombre.toUpperCase()} <span class="badge">${d.nivel_incidencia}</span></h4>
            <div class="info-grid">
              <p><i class="fas fa-user"></i> <strong>Reportado por:</strong> ${d.nombre_completo}</p>
              <p><i class="fas fa-phone"></i> <strong>Teléfono:</strong> ${d.numero_celular || "No disponible"}</p>
              <p><i class="fas fa-calendar-alt"></i> <strong>Fecha:</strong> ${d.fecha}</p>
              <p><i class="fas fa-clock"></i> <strong>Hora:</strong> ${d.hora}</p>
              <p><i class="fas fa-info-circle"></i> <strong>Descripción:</strong> ${d.descripcion}</p>
              <p><i class="fas fa-layer-group"></i> <strong>Tipo:</strong> ${d.tipo_incidencia}</p>
              <p><i class="fas fa-check-circle"></i> <strong>Estado:</strong> ${d.estado == "1" ? "Pendiente" : d.estado}</p>
            </div>

            ${d.fotos.length > 0 ? `
              <div>
                <div class="section-title"><i class="fas fa-image"></i> Imágenes</div>
                <div class="media-grid">
                  ${d.fotos.map(foto => `<img src="${foto}" alt="Foto denuncia">`).join("")}
                </div>
              </div>` : ""}

            ${d.videos.length > 0 ? `
              <div>
                <div class="section-title"><i class="fas fa-video"></i> Videos</div>
                <div class="media-grid">
                  ${d.videos.map(video => `<video controls src="${video}"></video>`).join("")}
                </div>
              </div>` : ""}

            ${d.audios.length > 0 ? `
              <div>
                <div class="section-title"><i class="fas fa-volume-up"></i> Audios</div>
                ${d.audios.map(audio => `<audio controls src="${audio}"></audio>`).join("")}
              </div>` : ""}
          </div>
        `;

      container.innerHTML = template;

      // Mapa
      if (!isNaN(lat) && !isNaN(lng)) {
        const map = L.map(mapElement).setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker([lat, lng]).addTo(map)
          .bindPopup(`<strong>${d.denuncia_nombre.toUpperCase()}</strong><br>${d.ubicacion}`)
          .openPopup();
      } else {
        mapElement.innerHTML = `<div class="section-title">Ubicación no disponible</div>`;
      }
    })
    .catch(error => {
      container.innerHTML = `<div class="card"><p class="text-danger">Error al obtener la denuncia: ${error.message}</p></div>`;
    });



  const btnAceptar = document.getElementById('btn-aceptar');
  const btnRechazar = document.getElementById('btn-rechazar');
  const modal = document.getElementById('modal-accion');
  const btnCerrarModal = document.getElementById('btn-cerrar-modal');
  const formAccion = document.getElementById('form-accion');
  const modalTitulo = document.getElementById('modal-titulo');
  const descripcionInput = document.getElementById('descripcion');
  const archivoInput = document.getElementById('archivo');

  let accionActual = null; // 'aceptar' o 'rechazar'

  btnAceptar.addEventListener('click', () => {
    accionActual = 'aceptar';
    modalTitulo.textContent = 'Confirmar Aceptación';
    descripcionInput.value = '';
    archivoInput.value = '';
    modal.style.display = 'flex';
  });

  btnRechazar.addEventListener('click', () => {
    accionActual = 'rechazar';
    modalTitulo.textContent = 'Confirmar Rechazo';
    descripcionInput.value = '';
    archivoInput.value = '';
    modal.style.display = 'flex';
  });

  btnCerrarModal.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });

  formAccion.addEventListener('submit', (e) => {
    e.preventDefault();

    const descripcion = descripcionInput.value.trim();
    const archivo = archivoInput.files[0];

    const formData = new FormData();
    formData.append('descripcion', descripcion);
    formData.append('accion', accionActual);  // 'aceptar' o 'rechazar'
    if (archivo) {
      formData.append('archivo', archivo);
    }

    fetch(`{{ BASE_URL }}/api/central/incidencia/procesar/{{ id }}`, {
      method: 'POST',
      body: formData,
    })
      .then(async (res) => {
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Error desconocido');
        }
        return res.json();
      })
      .then(data => {
        
        modal.style.display = 'none';
        // Opcional: refrescar página o datos
        window.location.href = '/denuncia_pendiente';
      })
      .catch(err => {
        alert('Error al procesar: ' + err.message);
      });
  });


</script>
{% endblock %}