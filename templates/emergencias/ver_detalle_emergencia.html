{% extends "partials/sidebar.html" %}
{% block title %} Detalle de Emergencia {% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<style>
  :root {
    --primary-red: #dc3545;
    --secondary-red: #c82333;
    --bg-color: #f5f7fa;
    --card-color: #ffffff;
    --text-primary: #2c3e50;
    --text-secondary: #6c757d;
    --border-color: #dee2e6;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --info-color: #17a2b8;
  }

  body {
    background-color: var(--bg-color);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    color: var(--text-primary);
  }

  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .page-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .page-title {
    font-size: 32px;
    font-weight: 700;
    color: #000000;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
  }

  .page-title i {
    color: var(--primary-red);
    font-size: 36px;
  }

  .content-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  .main-card {
    background: var(--card-color);
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    overflow: hidden;
  }

  .card-header {
    background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
    padding: 1.5rem 2rem;
    color: white;
  }

  .card-header-title {
    font-size: 24px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .emergency-icon {
    font-size: 28px;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
  }

  .status-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    margin-left: auto;
  }

  .status-pending {
    background: #ffc107;
    color: #000;
  }

  .status-accepted {
    background: #28a745;
    color: white;
  }

  .status-rejected {
    background: #dc3545;
    color: white;
  }

  .card-body {
    padding: 2rem;
  }

  .info-section {
    margin-bottom: 2rem;
  }

  .section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--primary-red);
  }

  .section-title i {
    color: var(--primary-red);
    font-size: 20px;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .info-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 1rem;
    background: #fff3f3;
    border-radius: 10px;
    transition: all 0.3s;
    border-left: 4px solid var(--primary-red);
  }

  .info-item:hover {
    background: #ffebee;
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
  }

  .info-item i {
    color: var(--primary-red);
    font-size: 20px;
    margin-top: 2px;
    min-width: 24px;
  }

  .info-content {
    flex: 1;
  }

  .info-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 13px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .info-value {
    color: var(--text-primary);
    font-size: 15px;
    word-break: break-word;
  }

  .emergency-type {
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    padding: 8px 16px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #c62828;
    border: 2px solid #ffcdd2;
  }

  /* Audio Player Styles */
  .audio-container {
    background: linear-gradient(135deg, #fff3f3 0%, #ffebee 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-top: 1rem;
    border: 2px solid #ffcdd2;
  }

  .audio-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1.5rem;
  }

  .audio-header i {
    font-size: 24px;
    color: var(--primary-red);
  }

  .audio-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .audio-player {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .audio-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .play-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
  }

  .play-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(220, 53, 69, 0.4);
  }

  .play-btn:active {
    transform: scale(0.95);
  }

  .time-info {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
  }

  .time-display {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    min-width: 100px;
  }

  .progress-container {
    flex: 1;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-red) 0%, var(--secondary-red) 100%);
    border-radius: 4px;
    width: 0%;
    transition: width 0.1s linear;
  }

  .volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .volume-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .volume-btn:hover {
    color: var(--primary-red);
  }

  .volume-slider {
    width: 80px;
    height: 6px;
    border-radius: 3px;
    background: #e9ecef;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--primary-red);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .volume-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--primary-red);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .download-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
  }

  .download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .audio-waveform {
    display: flex;
    align-items: center;
    gap: 2px;
    height: 40px;
    margin-top: 1rem;
  }

  .wave-bar {
    flex: 1;
    background: #ffcdd2;
    border-radius: 2px;
    transition: all 0.3s;
    animation: wave 1s ease-in-out infinite;
  }

  @keyframes wave {
    0%, 100% { height: 20%; }
    50% { height: 100%; }
  }

  .wave-bar:nth-child(1) { animation-delay: 0s; }
  .wave-bar:nth-child(2) { animation-delay: 0.1s; }
  .wave-bar:nth-child(3) { animation-delay: 0.2s; }
  .wave-bar:nth-child(4) { animation-delay: 0.3s; }
  .wave-bar:nth-child(5) { animation-delay: 0.4s; }
  .wave-bar:nth-child(6) { animation-delay: 0.3s; }
  .wave-bar:nth-child(7) { animation-delay: 0.2s; }
  .wave-bar:nth-child(8) { animation-delay: 0.1s; }

  .no-audio {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
  }

  .no-audio i {
    font-size: 48px;
    margin-bottom: 1rem;
    color: #ffcdd2;
  }

  .map-container {
    background: var(--card-color);
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    margin-top: 2rem;
  }

  .map-header {
    background: linear-gradient(135deg, var(--primary-red) 0%, var(--secondary-red) 100%);
    padding: 1rem 1.5rem;
    color: white;
  }

  .map-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #map {
    height: 400px;
    width: 100%;
  }

  .map-placeholder {
    padding: 3rem;
    text-align: center;
    color: var(--text-secondary);
    background: #fff3f3;
  }

  .map-placeholder i {
    font-size: 48px;
    margin-bottom: 1rem;
    color: #ffcdd2;
  }

  .action-buttons {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-action {
    padding: 14px 32px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
    color: white;
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger-color) 0%, var(--secondary-red) 100%);
    color: white;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .page-container {
      padding: 1rem;
    }

    .audio-controls {
      flex-wrap: wrap;
    }

    .volume-control {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">
      <i class="fas fa-siren-on"></i>
      Detalle de Emergencia
    </h1>
  </div>

  <div class="content-grid">
    <div id="emergencia-container"></div>
    
    <div class="map-container" id="map-container">
      <div class="map-header">
        <h3><i class="fas fa-map-marker-alt"></i> Ubicación de la Emergencia</h3>
      </div>
      <div id="map"></div>
    </div>

    {% if vision %}
    <div class="action-buttons">
      <button id="btn-aceptar" class="btn-action btn-success">
        <i class="fas fa-check-circle"></i> Aceptar Emergencia
      </button>
      <button id="btn-rechazar" class="btn-action btn-danger">
        <i class="fas fa-times-circle"></i> Rechazar Emergencia
      </button>
    </div>
    {% endif %}
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const container = document.getElementById("emergencia-container");
  const mapElement = document.getElementById("map");
  let audioElement = null;
  let isPlaying = false;

  fetch("{{ BASE_URL }}/api/central/emergencias/detalle/{{ id }}")
    .then(res => res.json())
    .then(data => {
      const d = data.emergencia;

      let lat = 0, lng = 0;
      if (d.ubicacion && d.ubicacion.includes(",")) {
        [lat, lng] = d.ubicacion.split(',').map(coord => parseFloat(coord.trim()));
      }

      let statusClass = 'status-pending';
      let statusText = 'Pendiente';
      if (d.estado === '2') {
        statusClass = 'status-accepted';
        statusText = 'Aceptada';
      } else if (d.estado === '3') {
        statusClass = 'status-rejected';
        statusText = 'Rechazada';
      }

      const iconosEmergencia = {
        'Incendio': '🔥',
        'Accidente': '🚑',
        'Robo': '🚨',
        'Violencia': '⚠️',
        'Desastre Natural': '🌪️',
        'Médica': '⚕️'
      };
      const emergenciaIcono = iconosEmergencia[d.nombre_emergencia] || '🚨';

      // Generar HTML del reproductor de audio
      const audioHTML = d.id_audio ? `
        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-volume-up"></i>
            Audio de Emergencia
          </h3>
          <div class="audio-container">
            <div class="audio-header">
              <i class="fas fa-microphone"></i>
              <h4>Grabación del Reporte</h4>
            </div>
            <div class="audio-player">
              <audio id="audio-player" preload="metadata">
                <source src="{{ BASE_URL }}/api/emergencias/audio/${d.id_audio}" type="audio/mp4">
                <source src="{{ BASE_URL }}/api/emergencias/audio/${d.id_audio}" type="audio/x-m4a">
                Tu navegador no soporta el elemento de audio.
              </audio>
              
              <div class="audio-controls">
                <button class="play-btn" id="play-btn">
                  <i class="fas fa-play"></i>
                </button>
                
                <div class="time-info">
                  <span class="time-display" id="time-display">00:00 / 00:00</span>
                  <div class="progress-container" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                  </div>
                </div>

                <div class="volume-control">
                  <button class="volume-btn" id="volume-btn">
                    <i class="fas fa-volume-up"></i>
                  </button>
                  <input type="range" class="volume-slider" id="volume-slider" 
                         min="0" max="100" value="100">
                </div>
              </div>

              <div class="audio-waveform" id="waveform">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
              </div>

              <button class="download-btn" onclick="descargarAudio(${d.id_audio})">
                <i class="fas fa-download"></i>
                Descargar Audio
              </button>
            </div>
          </div>
        </div>
      ` : `
        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-volume-up"></i>
            Audio de Emergencia
          </h3>
          <div class="audio-container">
            <div class="no-audio">
              <i class="fas fa-microphone-slash"></i>
              <p>No hay audio disponible para esta emergencia</p>
            </div>
          </div>
        </div>
      `;

      const template = `
        <div class="main-card">
          <div class="card-header">
            <div class="card-header-title">
              <span class="emergency-icon">${emergenciaIcono}</span>
              Emergencia #${d.id_incidencia}
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
          </div>

          <div class="card-body">
            <div class="info-section">
              <h3 class="section-title">
                <i class="fas fa-siren"></i>
                Tipo de Emergencia
              </h3>
              <div class="emergency-type">
                ${emergenciaIcono} ${d.nombre_emergencia}
              </div>
            </div>

            ${audioHTML}

            <div class="info-section">
              <h3 class="section-title">
                <i class="fas fa-user-shield"></i>
                Información del Reportante
              </h3>
              <div class="info-grid">
                <div class="info-item">
                  <i class="fas fa-user"></i>
                  <div class="info-content">
                    <div class="info-label">Nombre Completo</div>
                    <div class="info-value">${d.nombre}</div>
                  </div>
                </div>
                
                <div class="info-item">
                  <i class="fas fa-id-card"></i>
                  <div class="info-content">
                    <div class="info-label">DNI</div>
                    <div class="info-value">${d.dni || "No disponible"}</div>
                  </div>
                </div>

                <div class="info-item">
                  <i class="fas fa-phone"></i>
                  <div class="info-content">
                    <div class="info-label">Teléfono</div>
                    <div class="info-value">${d.cel_us || "No disponible"}</div>
                  </div>
                </div>

                <div class="info-item">
                  <i class="fas fa-phone-volume"></i>
                  <div class="info-content">
                    <div class="info-label">Número de Contacto</div>
                    <div class="info-value">${d.numero || "No disponible"}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="info-section">
              <h3 class="section-title">
                <i class="fas fa-info-circle"></i>
                Detalles de la Emergencia
              </h3>
              <div class="info-grid">
                <div class="info-item">
                  <i class="fas fa-calendar-alt"></i>
                  <div class="info-content">
                    <div class="info-label">Fecha</div>
                    <div class="info-value">${d.fecha}</div>
                  </div>
                </div>

                <div class="info-item">
                  <i class="fas fa-clock"></i>
                  <div class="info-content">
                    <div class="info-label">Hora</div>
                    <div class="info-value">${d.hora}</div>
                  </div>
                </div>

                <div class="info-item">
                  <i class="fas fa-map-marker-alt"></i>
                  <div class="info-content">
                    <div class="info-label">Ubicación</div>
                    <div class="info-value">${d.ubicacion || 'No disponible'}</div>
                  </div>
                </div>

                <div class="info-item">
                  <i class="fas fa-check-circle"></i>
                  <div class="info-content">
                    <div class="info-label">Estado</div>
                    <div class="info-value">${statusText}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      container.innerHTML = template;

      // Inicializar reproductor de audio si existe
      if (d.id_audio) {
        inicializarReproductorAudio();
      }

      // Mapa
      if (!isNaN(lat) && !isNaN(lng)) {
        const map = L.map(mapElement).setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`
          <strong>${emergenciaIcono} ${d.nombre_emergencia}</strong><br>
          Emergencia #${d.id_incidencia}<br>
          ${d.ubicacion}
        `).openPopup();
      } else {
        mapElement.innerHTML = `
          <div class="map-placeholder">
            <i class="fas fa-map-marked-alt"></i>
            <p>Ubicación no disponible</p>
          </div>
        `;
      }
    })
    .catch(error => {
      container.innerHTML = `
        <div class="main-card">
          <div class="card-body">
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <p>Error al cargar la emergencia: ${error.message}</p>
            </div>
          </div>
        </div>
      `;
    });

  // Funciones del reproductor de audio
  function inicializarReproductorAudio() {
    audioElement = document.getElementById('audio-player');
    const playBtn = document.getElementById('play-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const timeDisplay = document.getElementById('time-display');
    const volumeSlider = document.getElementById('volume-slider');
    const volumeBtn = document.getElementById('volume-btn');
    const waveform = document.getElementById('waveform');

    // Play/Pause
    playBtn.addEventListener('click', () => {
      if (isPlaying) {
        audioElement.pause();
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        waveform.style.display = 'none';
      } else {
        audioElement.play();
        playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        waveform.style.display = 'flex';
      }
      isPlaying = !isPlaying;
    });

    // Actualizar tiempo
    audioElement.addEventListener('timeupdate', () => {
      const progress = (audioElement.currentTime / audioElement.duration) * 100;
      progressBar.style.width = progress + '%';
      
      const currentMin = Math.floor(audioElement.currentTime / 60);
      const currentSec = Math.floor(audioElement.currentTime % 60);
      const durationMin = Math.floor(audioElement.duration / 60);
      const durationSec = Math.floor(audioElement.duration % 60);
      
      timeDisplay.textContent = 
        `${currentMin.toString().padStart(2, '0')}:${currentSec.toString().padStart(2, '0')} / ` +
        `${durationMin.toString().padStart(2, '0')}:${durationSec.toString().padStart(2, '0')}`;
    });

    // Cuando termina el audio
    audioElement.addEventListener('ended', () => {
      playBtn.innerHTML = '<i class="fas fa-play"></i>';
      isPlaying = false;
      waveform.style.display = 'none';
      progressBar.style.width = '0%';
    });

    // Click en la barra de progreso
    progressContainer.addEventListener('click', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      audioElement.currentTime = percent * audioElement.duration;
    });

    // Control de volumen
    volumeSlider.addEventListener('input', (e) => {
      const volume = e.target.value / 100;
      audioElement.volume = volume;
      updateVolumeIcon(volume);
    });

    volumeBtn.addEventListener('click', () => {
      if (audioElement.volume > 0) {
        audioElement.volume = 0;
        volumeSlider.value = 0;
        updateVolumeIcon(0);
      } else {
        audioElement.volume = 1;
        volumeSlider.value = 100;
        updateVolumeIcon(1);
      }
    });

    function updateVolumeIcon(volume) {
      const icon = volumeBtn.querySelector('i');
      if (volume === 0) {
        icon.className = 'fas fa-volume-mute';
      } else if (volume < 0.5) {
        icon.className = 'fas fa-volume-down';
      } else {
        icon.className = 'fas fa-volume-up';
      }
    }
  }

  function descargarAudio(idAudio) {
    const url = `{{ BASE_URL }}/api/emergencias/audio/${idAudio}`;
    const a = document.createElement('a');
    a.href = url;
    a.download = `audio_emergencia_${idAudio}.3gp`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    Swal.fire({
      icon: 'success',
      title: 'Descargando...',
      text: 'El audio se está descargando',
      timer: 2000,
      showConfirmButton: false
    });
  }

  // Modal y formulario (código existente del modal)
  const btnAceptar = document.getElementById('btn-aceptar');
  const btnRechazar = document.getElementById('btn-rechazar');
  const modal = document.getElementById('modal-accion');

  // Código del modal omitido por brevedad - usar el código existente del documento original

  // Código del modal omitido por brevedad - usar el código existente del documento original
  const btnCerrarModal = document.getElementById('btn-cerrar-modal');
  const formAccion = document.getElementById('form-accion');
  const modalTitulo = document.getElementById('modal-titulo');
  const descripcionInput = document.getElementById('descripcion');
  const archivoInput = document.getElementById('archivo');
  const archivoPreview = document.getElementById('archivo-preview');

  let accionActual = null;

  if (btnAceptar) {
    btnAceptar.addEventListener('click', () => {
      accionActual = 'aceptar';
      modalTitulo.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Aceptación de Emergencia';
      resetForm();
      modal.style.display = 'flex';
    });
  }

  if (btnRechazar) {
    btnRechazar.addEventListener('click', () => {
      accionActual = 'rechazar';
      modalTitulo.innerHTML = '<i class="fas fa-times-circle"></i> Confirmar Rechazo de Emergencia';
      resetForm();
      modal.style.display = 'flex';
    });
  }

  btnCerrarModal.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });

  // Manejo de archivo
  archivoInput.addEventListener('change', function() {
    if (this.files.length > 0) {
      const archivo = this.files[0];
      archivoPreview.querySelector('.archivo-nombre').textContent = archivo.name;
      archivoPreview.style.display = 'flex';
      document.querySelector('.file-label .file-text').textContent = 'Cambiar archivo';
    }
  });

  archivoPreview.querySelector('.archivo-quitar').addEventListener('click', function() {
    archivoInput.value = '';
    archivoPreview.style.display = 'none';
    document.querySelector('.file-label .file-text').textContent = 'Seleccionar archivo';
  });

  function resetForm() {
    descripcionInput.value = '';
    archivoInput.value = '';
    archivoPreview.style.display = 'none';
    document.querySelector('.file-label .file-text').textContent = 'Seleccionar archivo';
  }

  formAccion.addEventListener('submit', (e) => {
    e.preventDefault();

    const descripcion = descripcionInput.value.trim();
    const archivo = archivoInput.files[0];

    if (!descripcion) {
      Swal.fire({
        icon: 'warning',
        title: 'Campo requerido',
        text: 'La descripción del motivo es obligatoria',
        confirmButtonColor: '#dc3545'
      });
      return;
    }

    const formData = new FormData();
    formData.append('descripcion', descripcion);
    formData.append('accion', accionActual);
    if (archivo) {
      formData.append('archivo', archivo);
    }

    Swal.fire({
      title: 'Procesando...',
      text: 'Por favor espere',
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => {
        Swal.showLoading();
      }
    });

    fetch(`{{ BASE_URL }}/api/central/incidencia/procesar/{{ id }}`, {
      method: 'POST',
      body: formData,
    })
      .then(async (res) => {
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Error desconocido');
        }
        return res.json();
      })
      .then(data => {
        modal.style.display = 'none';
        
        Swal.fire({
          icon: 'success',
          title: '¡Éxito!',
          text: `Emergencia ${accionActual === 'aceptar' ? 'aceptada' : 'rechazada'} correctamente`,
          confirmButtonColor: '#dc3545',
          confirmButtonText: 'Ir a emergencias pendientes'
        }).then(() => {
          window.location.href = '/emergencia_pendiente';
        });
      })
      .catch(err => {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al procesar: ' + err.message,
          confirmButtonColor: '#dc3545'
        });
      });
  });
</script>
{% endblock %}