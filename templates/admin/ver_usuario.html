{% extends "partials/sidebar.html" %}
{% block title %} Ver Usuario {% endblock %}
{% block content %}


<div class="content">
    <h1 id="titulo">Ver Usuario</h1>
    <table id="tableUsuario" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Id</th>
                <th>Nombre del area</th>
                <th>Correo</th>

                <th>Contraseña</th>

                <th>Acciones</th>
            </tr>
        </thead>
    </table>
</div>

<div id="modal-detalle" class="modal">
    <div class="modal-content">
        <span class="cerrar" onclick="cerrarModal()">&times;</span>
        <h2>Cambiar Contraseña</h2>
        <form onsubmit="return enviarNuevaContrasena(event)">
            <input type="hidden" id="id-correo-hidden">
            <label for="nueva-contrasena">Nueva contraseña:</label><br>
            <input type="password" id="nueva-contrasena" required><br><br>
            <button type="submit">Guardar</button>
        </form>
        <p id="respuesta-servidor"></p>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>




<script>
    $(document).ready(function () {
        $('#tableUsuario').DataTable({
            ajax: {
                url: '{{ BASE_URL }}/api/central/usuarios/correos',
                dataSrc: function (json) {
                    if (!json || !json.message) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Sin datos',
                            text: 'Aún no se encuentran datos',
                            confirmButtonText: 'Aceptar'
                        });
                        return [];
                    }
                    return json.message;
                },
                error: function (xhr, error, thrown) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Sin datos',
                        text: 'Aún no se encuentran datos',
                        confirmButtonText: 'Aceptar'
                    });
                    console.error('Error en DataTables:', xhr.responseText);
                }
            },
            columns: [
                { data: 'id_correo' },
                { data: 'nombre_area' },
                { data: 'correo' },
                { data: 'contra' },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <button class="btn-ver" onclick="verDetalle('${row.id_correo}')">Cambiar contraseña</button>
                            
                        `;
                    }
                }
            ],
            order: [[0, 'desc']],
            responsive: true,
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
            }

        });
    });

    function verDetalle(id_correo) {
        document.getElementById('modal-detalle').style.display = 'block';
        document.getElementById('id-correo-hidden').value = id_correo;
        document.getElementById('respuesta-servidor').textContent = "";
    }

    function cerrarModal() {
        document.getElementById('modal-detalle').style.display = 'none';
    }

    window.onclick = function (event) {
        const modal = document.getElementById('modal-detalle');
        if (event.target == modal) {
            cerrarModal();
        }
    }

    function enviarNuevaContrasena(event) {
        event.preventDefault();

        const id_usuario = document.getElementById('id-correo-hidden').value;
        const nueva_contrasena = document.getElementById('nueva-contrasena').value;

        fetch('{{ BASE_URL }}/api/central/usuarios/cambiar_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id_usuario: id_usuario,
                nueva_contrasena: nueva_contrasena
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.mensaje) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Contraseña cambiada!',
                        text: data.mensaje,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    cerrarModal(); // Oculta el modal
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || "No se pudo cambiar la contraseña"
                    });
                }
                $('#tableUsuario').DataTable().ajax.reload();
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error del servidor',
                    text: 'No se pudo conectar con el servidor'
                });
                console.error("Error:", error);
            });

        return false;
    }



    // También cerrar modal si el usuario hace clic fuera del contenido
    window.onclick = function (event) {
        const modal = document.getElementById('modal-detalle');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }


    

</script>





<style>
    .btn-ver {
        background-color: #2196F3;
        color: white;
        border: none;
        padding: 4px 8px;
        margin-right: 5px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-eliminar {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }







    /* Estilo general del fondo del modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    /* Contenedor del contenido del modal */
    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        position: relative;
        font-family: 'Segoe UI', sans-serif;
    }

    /* Botón de cerrar */
    .cerrar {
        position: absolute;
        right: 15px;
        top: 10px;
        font-size: 24px;
        font-weight: bold;
        color: #888;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .cerrar:hover {
        color: #000;
    }

    /* Etiquetas e inputs */
    label {
        font-weight: 600;
        margin-bottom: 5px;
        display: inline-block;
    }

    input[type="password"] {
        width: 100%;
        padding: 10px;
        margin-top: 4px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    input[type="password"]:focus {
        border-color: #4a90e2;
        outline: none;
    }

    /* Botón de guardar */
    button[type="submit"] {
        background-color: #4a90e2;
        color: white;
        border: none;
        padding: 10px 18px;
        margin-top: 10px;
        font-size: 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%;
    }

    button[type="submit"]:hover {
        background-color: #357ab8;
    }

    /* Mensaje debajo del formulario */
    #respuesta-servidor {
        margin-top: 12px;
        color: #333;
        font-size: 14px;
    }
</style>



{% endblock %}