{% extends "partials/sidebar.html" %}
{% block title %} Predicci√≥n de Incidencias {% endblock %}
{% block content %}

<style>
  :root {
    --bg-light: #fff;
    --bg-dark: #121212;
    --text-light: #000;
    --text-dark: #eee;
    --card-bg-light: #f3f3f3;
    --card-bg-dark: #1e1e1e;
    --shadow-light: rgba(0, 0, 0, 0.1);
    --shadow-dark: rgba(255, 255, 255, 0.1);
    --primary: #4a90e2;
    --success: #4caf50;
    --warning: #ff9800;
    --danger: #f44336;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-light);
    color: var(--text-light);
    transition: background-color 0.3s, color 0.3s;
  }

  body.dark {
    background-color: var(--bg-dark);
    color: var(--text-dark);
  }

  .prediccion-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
  }

  .header-section h1 {
    margin: 0;
    font-size: 28px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .status-badge {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .status-badge.success {
    background-color: rgba(76, 175, 80, 0.2);
    color: var(--success);
  }

  .status-badge.warning {
    background-color: rgba(255, 152, 0, 0.2);
    color: var(--warning);
  }

  /* Tabs de navegaci√≥n */
  .tabs-nav {
    display: flex;
    gap: 10px;
    border-bottom: 2px solid var(--card-bg-light);
    margin-bottom: 30px;
    overflow-x: auto;
  }

  body.dark .tabs-nav {
    border-bottom-color: var(--card-bg-dark);
  }

  .tab-btn {
    padding: 12px 24px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-light);
    transition: all 0.3s;
    white-space: nowrap;
  }

  body.dark .tab-btn {
    color: var(--text-dark);
  }

  .tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }

  .tab-btn:hover:not(.active) {
    background-color: rgba(74, 144, 226, 0.1);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Cards */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .metric-card {
    background: var(--card-bg-light);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px var(--shadow-light);
    transition: transform 0.2s, box-shadow 0.3s;
  }

  body.dark .metric-card {
    background: var(--card-bg-dark);
    box-shadow: 0 2px 8px var(--shadow-dark);
  }

  .metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px var(--shadow-light);
  }

  body.dark .metric-card:hover {
    box-shadow: 0 4px 16px var(--shadow-dark);
  }

  .metric-card h3 {
    margin: 0 0 8px;
    font-size: 14px;
    text-transform: uppercase;
    opacity: 0.7;
  }

  .metric-value {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
  }

  .metric-subtitle {
    font-size: 13px;
    opacity: 0.6;
  }

  /* Control Panel */
  .control-panel {
    background: var(--card-bg-light);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px var(--shadow-light);
  }

  body.dark .control-panel {
    background: var(--card-bg-dark);
    box-shadow: 0 2px 8px var(--shadow-dark);
  }

  .control-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: flex-end;
    margin-bottom: 20px;
  }

  .control-group {
    flex: 1;
    min-width: 150px;
  }

  .control-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
  }

  .control-group input,
  .control-group select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--card-bg-light);
    border-radius: 8px;
    font-size: 14px;
    background: var(--bg-light);
    color: var(--text-light);
    box-sizing: border-box;
  }

  body.dark .control-group input,
  body.dark .control-group select {
    background: var(--bg-dark);
    color: var(--text-dark);
    border-color: var(--card-bg-dark);
  }

  .btn {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: #3a7bc8;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-success:hover {
    background: #45a049;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .btn-danger:hover {
    background: #da190b;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Charts */
  .chart-container {
    background: var(--card-bg-light);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px var(--shadow-light);
  }

  body.dark .chart-container {
    background: var(--card-bg-dark);
    box-shadow: 0 2px 8px var(--shadow-dark);
  }

  .chart-container h3 {
    margin: 0 0 20px;
    font-size: 18px;
  }

  canvas {
    max-height: 400px;
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
  }

  .spinner {
    border: 4px solid rgba(74, 144, 226, 0.1);
    border-radius: 50%;
    border-top: 4px solid var(--primary);
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Alert */
  .alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .alert-success {
    background: rgba(76, 175, 80, 0.1);
    color: var(--success);
    border-left: 4px solid var(--success);
  }

  .alert-error {
    background: rgba(244, 67, 54, 0.1);
    color: var(--danger);
    border-left: 4px solid var(--danger);
  }

  .alert-warning {
    background: rgba(255, 152, 0, 0.1);
    color: var(--warning);
    border-left: 4px solid var(--warning);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .header-section h1 {
      font-size: 22px;
    }

    .control-row {
      flex-direction: column;
    }

    .control-group {
      width: 100%;
    }

    .tabs-nav {
      overflow-x: auto;
    }

    .cards-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Loading bar */
  .loading-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: transparent;
    z-index: 9999;
    display: none;
  }

  .loading-bar.active {
    display: block;
  }

  .loading-bar-progress {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--success));
    width: 0%;
    transition: width 0.3s ease;
    box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
  }

  /* Progress overlay */
  .progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9998;
  }

  body.dark .progress-overlay {
    background: rgba(0, 0, 0, 0.85);
  }

  .progress-overlay.active {
    display: flex;
  }

  .progress-content {
    background: var(--card-bg-light);
    padding: 30px 40px;
    border-radius: 12px;
    text-align: center;
    min-width: 300px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  body.dark .progress-content {
    background: var(--card-bg-dark);
  }

  .progress-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(74, 144, 226, 0.2);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  .progress-text {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .progress-subtext {
    font-size: 13px;
    opacity: 0.7;
  }

  .progress-bar-container {
    width: 100%;
    height: 8px;
    background: var(--card-bg-light);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 15px;
  }

  body.dark .progress-bar-container {
    background: var(--bg-dark);
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--success));
    width: 0%;
    transition: width 0.5s ease;
  }

  .progress-percentage {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
    margin-top: 10px;
  }

  /* Comparison table */
  .comparison-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .comparison-table th,
  .comparison-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--card-bg-light);
  }

  body.dark .comparison-table th,
  body.dark .comparison-table td {
    border-bottom-color: var(--card-bg-dark);
  }

  .comparison-table th {
    font-weight: 600;
    background: var(--card-bg-light);
  }

  body.dark .comparison-table th {
    background: var(--card-bg-dark);
  }

  .comparison-table tr:hover {
    background: rgba(74, 144, 226, 0.05);
  }
</style>

<div class="prediccion-container">
  <!-- Header -->
  <div class="header-section">
    <h1>
      üîÆ Predicci√≥n de Incidencias
      <span class="status-badge success" id="statusBadge">
        <span>‚óè</span> Modelo Cargado
      </span>
    </h1>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" onclick="switchTab('prediccion')">üìä Predicci√≥n</button>
    <button class="tab-btn" onclick="switchTab('analisis')">üìâ An√°lisis Hist√≥rico</button>
    <button class="tab-btn" onclick="switchTab('metricas')">üìà M√©tricas del Modelo</button>
    <button class="tab-btn" onclick="switchTab('comparacion')">üîÑ Comparaci√≥n Temporal</button>
    <button class="tab-btn" onclick="switchTab('recursos')">üéØ Asignaci√≥n de Recursos</button>
    <button class="tab-btn" onclick="switchTab('exportar')">üíæ Exportar Datos</button>
    <button class="tab-btn" onclick="switchTab('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
  </div>

  <!-- Tab 1: Predicci√≥n -->
  <div id="tab-prediccion" class="tab-content active">
    <!-- Control Panel -->
    <div class="control-panel">
      <h3 style="margin-top: 0;">üéØ Configurar Predicci√≥n</h3>
      
      <div class="control-row">
        <div class="control-group">
          <label>A√±o</label>
          <input type="number" id="yearInput" min="2027" max="2035" value="2027">
        </div>
        <div class="control-group">
          <label>Mes</label>
          <select id="monthInput">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="predecirMes()">
          üîÆ Predecir Mes
        </button>
      </div>

      <div class="control-row" style="margin-bottom: 0;">
        <div class="control-group">
          <label>Predecir Rango de Meses</label>
          <input type="number" id="rangoMeses" min="1" max="24" value="6" placeholder="Ej: 6 meses">
        </div>
        <button class="btn btn-success" onclick="predecirRango()">
          üìÖ Predecir Rango
        </button>
      </div>
    </div>

    <!-- Resultado de predicci√≥n -->
    <div id="resultadoPrediccion" style="display: none;">
      <!-- Cards con resumen -->
      <div class="cards-grid">
        <div class="metric-card">
          <h3>üìã Total Denuncias Ciudadanas</h3>
          <div class="metric-value" id="totalDenuncias">-</div>
          <div class="metric-subtitle">Casos esperados en el mes<br><small style="opacity: 0.6;">Suma de todos los tipos de denuncia</small></div>
        </div>
        <div class="metric-card">
          <h3>üö® Total Llamadas Emergencia</h3>
          <div class="metric-value" id="totalEmergencias">-</div>
          <div class="metric-subtitle">Llamadas esperadas al mes<br><small style="opacity: 0.6;">Polic√≠a, bomberos, ambulancia, etc.</small></div>
        </div>
        <div class="metric-card">
          <h3>‚ö†Ô∏è Denuncia M√°s Frecuente</h3>
          <div class="metric-value" id="tipoMasFrecuente" style="font-size: 20px;">-</div>
          <div class="metric-subtitle">Tipo con m√°s casos<br><small style="opacity: 0.6;">Priorizar recursos para este tipo</small></div>
        </div>
        <div class="metric-card">
          <h3>üéØ Precisi√≥n del Modelo</h3>
          <div class="metric-value" id="confianzaModelo">-</div>
          <div class="metric-subtitle">Nivel de confiabilidad<br><small style="opacity: 0.6;">>90% = Muy confiable</small></div>
        </div>
      </div>

      <!-- Gr√°ficos -->
      <div class="chart-container">
        <h3>üìä Predicci√≥n de Denuncias por Tipo</h3>
        <canvas id="chartDenuncias"></canvas>
      </div>

      <div class="chart-container">
        <h3>üö® Predicci√≥n de Emergencias por Tipo</h3>
        <canvas id="chartEmergencias"></canvas>
      </div>
    </div>
  </div>

  <!-- Tab 2: An√°lisis Hist√≥rico NUEVO -->
  <div id="tab-analisis" class="tab-content">
    <div class="control-panel">
      <h3 style="margin-top: 0;">üìä An√°lisis de Datos Hist√≥ricos</h3>
      <p style="font-size: 14px; opacity: 0.7; margin-bottom: 20px;">
        Explore patrones hist√≥ricos para entender mejor las predicciones futuras
      </p>
      
      <div class="control-row">
        <div class="control-group">
          <label>Tipo de An√°lisis</label>
          <select id="tipoAnalisis">
            <option value="tendencia">Tendencia Anual</option>
            <option value="estacionalidad">Estacionalidad Mensual</option>
            <option value="dia_semana">Distribuci√≥n por D√≠a de Semana</option>
            <option value="correlacion">Correlaci√≥n entre Tipos</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="generarAnalisisHistorico()">
          üìà Generar An√°lisis
        </button>
      </div>
    </div>

    <div id="resultadoAnalisis" style="display: none;">
      <div class="chart-container">
        <h3 id="tituloAnalisis">An√°lisis</h3>
        <canvas id="chartAnalisis"></canvas>
      </div>

      <div class="control-panel" id="insightsAnalisis">
        <h3>üí° Insights Detectados</h3>
        <div id="listaInsights"></div>
      </div>
    </div>
  </div>

  <!-- Tab 3: M√©tricas (ya existente, solo cambio el orden) -->
  <div id="tab-metricas" class="tab-content">
    <div class="alert alert-warning" style="margin-bottom: 20px;">
      <span>‚ÑπÔ∏è</span>
      <div>
        <strong>Sobre las M√©tricas:</strong> Estas estad√≠sticas muestran qu√© tan preciso es el modelo al predecir. 
        Un error menor significa predicciones m√°s exactas. Un score mayor a 85% indica alta confiabilidad.
      </div>
    </div>

    <div class="cards-grid">
      <div class="metric-card">
        <h3>üìä Precisi√≥n - Denuncias</h3>
        <div class="metric-value" id="scoreDenuncias">-</div>
        <div class="metric-subtitle" id="nivelDenuncias">-</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressDenuncias" style="width: 0%"></div>
        </div>
        <small style="opacity: 0.7; display: block; margin-top: 8px;">
          Qu√© tan acertado es el modelo prediciendo denuncias ciudadanas
        </small>
      </div>
      <div class="metric-card">
        <h3>üìä Precisi√≥n - Emergencias</h3>
        <div class="metric-value" id="scoreEmergencias">-</div>
        <div class="metric-subtitle" id="nivelEmergencias">-</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressEmergencias" style="width: 0%"></div>
        </div>
        <small style="opacity: 0.7; display: block; margin-top: 8px;">
          Qu√© tan acertado es el modelo prediciendo llamadas de emergencia
        </small>
      </div>
      <div class="metric-card">
        <h3>üìè Error Promedio (Denuncias)</h3>
        <div class="metric-value" id="maeDenuncias">-</div>
        <div class="metric-subtitle">casos de diferencia<br><small style="opacity: 0.6;">Cu√°nto se equivoca en promedio</small></div>
      </div>
      <div class="metric-card">
        <h3>üìè Error Promedio (Emergencias)</h3>
        <div class="metric-value" id="maeEmergencias">-</div>
        <div class="metric-subtitle">llamadas de diferencia<br><small style="opacity: 0.6;">Cu√°nto se equivoca en promedio</small></div>
      </div>
    </div>

    <div class="chart-container">
      <h3>üìâ Precisi√≥n por Tipo de Denuncia</h3>
      <p style="font-size: 14px; opacity: 0.7; margin-bottom: 15px;">
        Este gr√°fico muestra qu√© tipos de denuncia son m√°s f√°ciles de predecir. 
        Una barra verde alta significa alta precisi√≥n (predicci√≥n confiable).
      </p>
      <canvas id="chartMetricas"></canvas>
    </div>

    <div class="control-panel" id="recomendaciones">
      <h3>üí° Recomendaciones para Mejorar el Sistema</h3>
      <p style="font-size: 14px; opacity: 0.7; margin-bottom: 15px;">
        Sugerencias autom√°ticas basadas en el desempe√±o actual del modelo
      </p>
      <div id="listaRecomendaciones"></div>
    </div>
  </div>

  <!-- Tab 3: Comparaci√≥n Temporal -->
  <div id="tab-comparacion" class="tab-content">
    <div class="control-panel">
      <h3 style="margin-top: 0;">üìÜ Comparar Predicciones</h3>
      <div class="control-row" style="margin-bottom: 0;">
        <div class="control-group">
          <label>Mes a Comparar</label>
          <select id="mesComparacion">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="compararAnos()">
          üîÑ Comparar entre A√±os
        </button>
      </div>
    </div>

    <div id="resultadoComparacion" style="display: none;">
      <div class="chart-container">
        <h3>üìä Evoluci√≥n Temporal - Mismo Mes en Diferentes A√±os</h3>
        <canvas id="chartComparacion"></canvas>
      </div>

      <div class="chart-container">
        <h3>üìã Tabla Comparativa</h3>
        <table class="comparison-table" id="tablaComparacion"></table>
      </div>
    </div>
  </div>

  <!-- Tab 5: Asignaci√≥n de Recursos NUEVO -->
  <div id="tab-recursos" class="tab-content">
    <div class="control-panel">
      <h3 style="margin-top: 0;">üéØ Planificador de Recursos</h3>
      <p style="font-size: 14px; opacity: 0.7; margin-bottom: 20px;">
        Calcule recursos necesarios basados en predicciones futuras
      </p>

      <div class="control-row">
        <div class="control-group">
          <label>Mes a Planificar</label>
          <input type="month" id="mesPlanificacion" />
        </div>
        <button class="btn btn-success" onclick="calcularRecursos()">
          üéØ Calcular Recursos Necesarios
        </button>
      </div>
    </div>

    <div id="resultadoRecursos" style="display: none;">
      <div class="cards-grid">
        <div class="metric-card">
          <h3>üë• Personal Requerido</h3>
          <div class="metric-value" id="personalRequerido">-</div>
          <div class="metric-subtitle">Empleados municipales<br><small style="opacity: 0.6;">Basado en 10 casos por persona/mes</small></div>
        </div>
        <div class="metric-card">
          <h3>üöó Veh√≠culos Necesarios</h3>
          <div class="metric-value" id="vehiculosNecesarios">-</div>
          <div class="metric-subtitle">Unidades m√≥viles<br><small style="opacity: 0.6;">Para respuesta r√°pida</small></div>
        </div>
        <div class="metric-card">
          <h3>üí∞ Presupuesto Estimado</h3>
          <div class="metric-value" id="presupuestoEstimado">-</div>
          <div class="metric-subtitle">Soles peruanos<br><small style="opacity: 0.6;">S/ 50 por caso en promedio</small></div>
        </div>
        <div class="metric-card">
          <h3>‚è∞ Horas de Trabajo</h3>
          <div class="metric-value" id="horasTrabajo">-</div>
          <div class="metric-subtitle">Horas-hombre<br><small style="opacity: 0.6;">2 horas por caso en promedio</small></div>
        </div>
      </div>

      <div class="chart-container">
        <h3>üìä Distribuci√≥n de Recursos por Tipo de Incidencia</h3>
        <canvas id="chartRecursos"></canvas>
      </div>

      <div class="control-panel">
        <h3>üìã Plan de Acci√≥n Sugerido</h3>
        <div id="planAccion"></div>
      </div>
    </div>
  </div>

   <!-- Tab: Exportar -->
  <div id="tab-exportar" class="tab-content">
    <div class="control-panel">
      <h3 style="margin-top: 0;">Exportar Reportes</h3>
      
      <div class="cards-grid">
        <div class="metric-card" style="cursor: pointer;" onclick="exportarPrediccion('excel')">
          <h3 style="color: #217346;">Exportar a Excel</h3>
          <p style="font-size: 14px; opacity: 0.7;">Incluye predicciones y m√©tricas completas</p>
          <button class="btn btn-success" style="width: 100%;">Descargar .XLSX</button>
        </div>

        <div class="metric-card" style="cursor: pointer;" onclick="exportarPrediccion('pdf')">
          <h3 style="color: #d32f2f;">Exportar a PDF</h3>
          <p style="font-size: 14px; opacity: 0.7;">Reporte ejecutivo con gr√°ficos</p>
          <button class="btn btn-danger" style="width: 100%;">Descargar .PDF</button>
        </div>

        <div class="metric-card" style="cursor: pointer;" onclick="exportarPrediccion('csv')">
          <h3 style="color: #1976d2;">Exportar a CSV</h3>
          <p style="font-size: 14px; opacity: 0.7;">Datos tabulares para an√°lisis</p>
          <button class="btn btn-primary" style="width: 100%;">Descargar .CSV</button>
        </div>

        <div class="metric-card" style="cursor: pointer;" onclick="exportarPrediccion('json')">
          <h3 style="color: #ff9800;">Exportar a JSON</h3>
          <p style="font-size: 14px; opacity: 0.7;">Formato para integraci√≥n</p>
          <button class="btn" style="width: 100%; background: #ff9800; color: white;">Descargar .JSON</button>
        </div>
      </div>

      <div class="control-panel">
        <h3>Opciones de Exportaci√≥n</h3>
        <div style="margin: 15px 0;">
          <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="incluirMetricas" checked>
            <span>Incluir m√©tricas de calidad del modelo</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="incluirGraficos" checked>
            <span>Incluir gr√°ficos generados (como im√°genes)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="incluirPredicciones" checked>
            <span>Incluir tabla de predicciones detallada</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <input type="checkbox" id="incluirRecomendaciones" checked>
            <span>Incluir recomendaciones del sistema</span>
          </label>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
          <h4 style="margin-top: 0;">Exportaci√≥n Avanzada con Gr√°ficos</h4>
          <p style="font-size: 13px; opacity: 0.8; margin-bottom: 15px;">
            Genera un reporte ejecutivo completo con todos los gr√°ficos como im√°genes de alta calidad
          </p>
          <button class="btn btn-primary" onclick="exportarReporteCompleto()" style="width: 100%;">
            Exportar Reporte Ejecutivo Completo
          </button>
        </div>

        <div style="margin-top: 20px;">
          <h4>Historial de Exportaciones</h4>
          <div id="historialExportaciones" style="font-size: 13px; opacity: 0.7;">
            No hay exportaciones recientes
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



  <!-- Tab 7: Configuraci√≥n (ya existente) -->
  <div id="tab-configuracion" class="tab-content">
    <div class="control-panel">
      <h3 style="margin-top: 0;">‚öôÔ∏è Informaci√≥n del Sistema de Predicci√≥n</h3>
      
      <div class="alert alert-warning">
        <span>‚ö†Ô∏è</span>
        <div>
          <strong>Sobre el Reentrenamiento:</strong> Esta acci√≥n actualiza el modelo con datos nuevos. 
          Solo realice esto si ha agregado informaci√≥n reciente al sistema. El proceso puede tardar 5-10 minutos.
        </div>
      </div>

      <div style="margin-top: 20px;">
        <h4>üìä Detalles T√©cnicos del Modelo Actual</h4>
        <table class="comparison-table">
          <tr>
            <th>Caracter√≠stica</th>
            <th>Valor</th>
            <th>Explicaci√≥n</th>
          </tr>
          <tr>
            <td><strong>Tipo de Modelo</strong></td>
            <td id="infoArquitectura">-</td>
            <td><small>Red neuronal avanzada para detectar patrones temporales</small></td>
          </tr>
          <tr>
            <td><strong>Tipos de Denuncias</strong></td>
            <td id="infoTiposDen">-</td>
            <td><small>Cantidad de categor√≠as diferentes que el modelo puede predecir</small></td>
          </tr>
          <tr>
            <td><strong>Tipos de Emergencias</strong></td>
            <td id="infoTiposEme">-</td>
            <td><small>Cantidad de servicios de emergencia monitoreados</small></td>
          </tr>
          <tr>
            <td><strong>√öltimo Dato Registrado</strong></td>
            <td id="infoUltimoMes">-</td>
            <td><small>Fecha m√°s reciente con informaci√≥n en el sistema</small></td>
          </tr>
          <tr>
            <td><strong>Memoria del Modelo</strong></td>
            <td><span id="infoLookback">-</span> meses</td>
            <td><small>Cu√°ntos meses anteriores usa para hacer predicciones</small></td>
          </tr>
          <tr>
            <td><strong>Datos de Entrenamiento</strong></td>
            <td id="infoPeriodoDatos">-</td>
            <td><small>Rango completo de fechas usadas para entrenar el modelo</small></td>
          </tr>
        </table>
      </div>

      <div style="margin-top: 30px; padding: 20px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
        <h4 style="margin-top: 0;">üîÑ ¬øCu√°ndo Reentrenar el Modelo?</h4>
        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
          <li>‚úÖ Cuando hayan pasado <strong>1-3 meses</strong> desde el √∫ltimo entrenamiento</li>
          <li>‚úÖ Si las predicciones difieren mucho de la <strong>realidad actual</strong></li>
          <li>‚úÖ Despu√©s de agregar <strong>datos hist√≥ricos nuevos</strong> al sistema</li>
          <li>‚úÖ Si nota cambios importantes en los <strong>patrones de incidencias</strong></li>
          <li>‚ùå NO reentrenar si los datos no han cambiado (no mejorar√° nada)</li>
        </ul>
      </div>

      <div style="margin-top: 30px; text-align: center;">
        <button class="btn btn-danger" onclick="reentrenarModelo()">
          üîÑ Iniciar Reentrenamiento del Modelo
        </button>
        <p style="font-size: 13px; opacity: 0.7; margin-top: 10px;">
          Esta acci√≥n puede tardar varios minutos. No cierre la ventana durante el proceso.
        </p>
      </div>

      <div id="entrenamientoProgress" style="display: none; margin-top: 20px;">
        <div class="loading">
          <div class="spinner"></div>
          <p><strong>Entrenando el modelo de inteligencia artificial...</strong></p>
          <p style="font-size: 14px; opacity: 0.7;">Esto puede tomar 5-10 minutos</p>
          <p style="font-size: 13px; opacity: 0.6; margin-top: 10px;">
            El modelo est√° aprendiendo patrones de los datos hist√≥ricos
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_URL = '{{ BASE_URL }}';

let chartDenuncias, chartEmergencias, chartMetricas, chartComparacion;
let modeloInfo = null;

// Mapeo de tipos de denuncia
const DENUNCIAS_MAP = {
  1: 'Ruidos molestos',
  2: 'Bullying y violencia familiar',
  3: 'Ocupaci√≥n v√≠a p√∫blica',
  4: 'Parques y jardines',
  5: 'Limpieza p√∫blica',
  6: 'Negocios informales',
  7: 'Otros',
  8: 'Peleas y conflictos',
  9: 'Lluvias intensas',
  10: 'Sismos',
  11: 'Incendio urbano',
  12: 'Riesgo de colapso'
};

// Mapeo de emergencias
const EMERGENCIAS_MAP = {
  2: 'Polic√≠a (911)',
  3: 'Serenazgo (955)',
  4: 'Ambulancia (666)',
  5: 'Bomberos Monsef√∫ (444)',
  6: 'Bomberos Chiclayo (922)'
};

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
  cargarInfoModelo();
  cargarMetricas();
});

function switchTab(tabName) {
  // Ocultar todos los tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  // Mostrar tab seleccionado
  document.getElementById(`tab-${tabName}`).classList.add('active');
  event.target.classList.add('active');

  // Cargar datos espec√≠ficos del tab
  if (tabName === 'metricas') {
    cargarMetricas();
  }
}

async function cargarInfoModelo() {
  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/info`);
    const data = await response.json();
    
    console.log("üîç Respuesta cruda del backend:", data);

    if (data.success) {
      // CORRECCI√ìN: Guardar directamente data.data
      modeloInfo = data.data;
      
      // Actualizar badge de estado - verificar si calidad_global existe
      const badge = document.getElementById('statusBadge');
      if (modeloInfo.calidad_global) {
        const score = Math.min(
          modeloInfo.calidad_global.denuncias.score,
          modeloInfo.calidad_global.emergencias.score
        );
        
        if (score >= 75) {
          badge.className = 'status-badge success';
          badge.innerHTML = '<span>‚óè</span> Modelo √ìptimo';
        } else if (score >= 60) {
          badge.className = 'status-badge warning';
          badge.innerHTML = '<span>‚óè</span> Modelo Aceptable';
        }
      }

      // Actualizar info en configuraci√≥n - acceso correcto
      document.getElementById('infoArquitectura').textContent = modeloInfo.modelo.arquitectura;
      document.getElementById('infoTiposDen').textContent = modeloInfo.datos.denuncias.tipos_unicos;
      document.getElementById('infoTiposEme').textContent = modeloInfo.datos.emergencias.tipos_unicos;
      document.getElementById('infoUltimoMes').textContent = modeloInfo.datos.denuncias.ultimo_mes;
      document.getElementById('infoLookback').textContent = modeloInfo.modelo.lookback_meses;
    }
  } catch (error) {
    console.error('Error cargando info del modelo:', error);
    document.getElementById('statusBadge').className = 'status-badge warning';
    document.getElementById('statusBadge').innerHTML = '<span>‚óè</span> Error de Conexi√≥n';
  }
}

async function predecirMes() {
  const year = parseInt(document.getElementById('yearInput').value);
  const month = parseInt(document.getElementById('monthInput').value);
  
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Prediciendo...';

  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/predecir`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ year, month })
    });

    const data = await response.json();

    if (data.success) {
      guardarUltimaPrediccion(year, month, data.data);
      mostrarPrediccion(data.data);
    } else {
      alert('Error: ' + data.error);
    }
  } catch (error) {
    alert('Error de conexi√≥n: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîÆ Predecir Mes';
  }
}

function mostrarPrediccion(data) {
  document.getElementById('resultadoPrediccion').style.display = 'block';
  
  // Calcular totales
  const totalDen = Object.values(data.denuncias).reduce((a, b) => a + b, 0);
  const totalEme = Object.values(data.emergencias).reduce((a, b) => a + b, 0);
  
  // Encontrar tipo m√°s frecuente con nombre descriptivo
  const maxDen = Math.max(...Object.values(data.denuncias));
  const tipoMaxId = Object.keys(data.denuncias).find(k => data.denuncias[k] === maxDen);
  const tipoMaxNombre = DENUNCIAS_MAP[tipoMaxId] || `Tipo ${tipoMaxId}`;
  
  // Actualizar cards con explicaciones
  document.getElementById('totalDenuncias').textContent = totalDen;
  document.getElementById('totalEmergencias').textContent = totalEme;
  document.getElementById('tipoMasFrecuente').textContent = tipoMaxNombre;
  document.getElementById('tipoMasFrecuente').style.fontSize = '16px';
  
  if (modeloInfo && modeloInfo.metricas_agregadas) {
    const precision = 100 - modeloInfo.metricas_agregadas.denuncias.mae_promedio * 2;
    document.getElementById('confianzaModelo').textContent = `${Math.round(precision)}%`;
  }

  // Preparar datos para gr√°fico con nombres descriptivos
  const denunciasData = Object.entries(data.denuncias).map(([id, valor]) => ({
    nombre: DENUNCIAS_MAP[id] || `Tipo ${id}`,
    valor: valor,
    id: id
  })).sort((a, b) => b.valor - a.valor);

  const labelsDen = denunciasData.map(d => d.nombre);
  const valuesDen = denunciasData.map(d => d.valor);
  
  // Colores por prioridad
  const coloresDen = denunciasData.map(d => {
    if (['9', '10', '11', '12'].includes(d.id)) return 'rgba(244, 67, 54, 0.8)';
    if (['2', '8'].includes(d.id)) return 'rgba(255, 152, 0, 0.8)';
    if (['1', '3', '6'].includes(d.id)) return 'rgba(255, 193, 7, 0.8)';
    return 'rgba(74, 144, 226, 0.8)';
  });
  
  if (chartDenuncias) chartDenuncias.destroy();
  
  chartDenuncias = new Chart(document.getElementById('chartDenuncias'), {
    type: 'bar',
    data: {
      labels: labelsDen,
      datasets: [{
        label: 'Casos Predichos',
        data: valuesDen,
        backgroundColor: coloresDen,
        borderColor: coloresDen.map(c => c.replace('0.8', '1')),
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: `üìä Predicci√≥n para ${data.fecha_prediccion} - Denuncias Ciudadanas`,
          font: { size: 16, weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const porcentaje = ((context.parsed.y / totalDen) * 100).toFixed(1);
              return `${context.parsed.y} casos (${porcentaje}% del total)`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            precision: 0,
            callback: function(value) {
              return value + ' casos';
            }
          },
          title: {
            display: true,
            text: 'Cantidad de Casos Esperados'
          }
        },
        x: {
          ticks: {
            autoSkip: false,
            maxRotation: 45,
            minRotation: 45,
            font: { size: 11 }
          }
        }
      }
    }
  });

  // Gr√°fico de emergencias
  const emergenciasData = Object.entries(data.emergencias)
    .filter(([id]) => id in EMERGENCIAS_MAP)
    .map(([id, valor]) => ({
      nombre: EMERGENCIAS_MAP[id],
      valor: valor
    }))
    .sort((a, b) => b.valor - a.valor);

  const labelsEme = emergenciasData.map(d => d.nombre);
  const valuesEme = emergenciasData.map(d => d.valor);
  
  const coloresEme = emergenciasData.map(d => {
    if (d.nombre.includes('Bomberos')) return 'rgba(244, 67, 54, 0.8)';
    if (d.nombre.includes('Ambulancia')) return 'rgba(33, 150, 243, 0.8)';
    if (d.nombre.includes('Polic√≠a')) return 'rgba(76, 175, 80, 0.8)';
    if (d.nombre.includes('Serenazgo')) return 'rgba(255, 152, 0, 0.8)';
    return 'rgba(156, 39, 176, 0.8)';
  });
  
  if (chartEmergencias) chartEmergencias.destroy();
  
  chartEmergencias = new Chart(document.getElementById('chartEmergencias'), {
    type: 'bar',
    data: {
      labels: labelsEme,
      datasets: [{
        label: 'Llamadas Predichas',
        data: valuesEme,
        backgroundColor: coloresEme,
        borderColor: coloresEme.map(c => c.replace('0.8', '1')),
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: `üö® Predicci√≥n para ${data.fecha_prediccion} - Llamadas de Emergencia`,
          font: { size: 16, weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const porcentaje = ((context.parsed.y / totalEme) * 100).toFixed(1);
              return `${context.parsed.y} llamadas (${porcentaje}% del total)`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            precision: 0,
            callback: function(value) {
              return value + ' llamadas';
            }
          },
          title: {
            display: true,
            text: 'Cantidad de Llamadas Esperadas'
          }
        },
        x: {
          ticks: {
            font: { size: 12 }
          }
        }
      }
    }
  });

  document.getElementById('resultadoPrediccion').scrollIntoView({ 
    behavior: 'smooth', 
    block: 'nearest' 
  });
}

async function predecirRango() {
  const year = parseInt(document.getElementById('yearInput').value);
  const month = parseInt(document.getElementById('monthInput').value);
  const meses = parseInt(document.getElementById('rangoMeses').value);
  
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Prediciendo...';

  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/predecir/rango`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        year_inicio: year, 
        month_inicio: month, 
        meses: meses 
      })
    });

    const data = await response.json();

    if (data.success) {
      mostrarPrediccionRango(data.data);
    } else {
      alert('Error: ' + data.error);
    }
  } catch (error) {
    alert('Error de conexi√≥n: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üìÖ Predecir Rango';
  }
}

function mostrarPrediccionRango(data) {
  document.getElementById('resultadoPrediccion').style.display = 'block';
  
  const labels = data.map(d => d.fecha_prediccion);
  const totalDenPorMes = data.map(d => Object.values(d.denuncias).reduce((a, b) => a + b, 0));
  const totalEmePorMes = data.map(d => Object.values(d.emergencias).reduce((a, b) => a + b, 0));
  
  const avgDen = Math.round(totalDenPorMes.reduce((a, b) => a + b, 0) / totalDenPorMes.length);
  const avgEme = Math.round(totalEmePorMes.reduce((a, b) => a + b, 0) / totalEmePorMes.length);
  const maxDen = Math.max(...totalDenPorMes);
  const minDen = Math.min(...totalDenPorMes);
  const maxEme = Math.max(...totalEmePorMes);
  const minEme = Math.min(...totalEmePorMes);
  
  document.getElementById('totalDenuncias').innerHTML = `${avgDen}<br><small style="font-size: 14px; opacity: 0.7;">Promedio mensual</small>`;
  document.getElementById('totalEmergencias').innerHTML = `${avgEme}<br><small style="font-size: 14px; opacity: 0.7;">Promedio mensual</small>`;
  document.getElementById('tipoMasFrecuente').innerHTML = `${data.length} meses<br><small style="font-size: 14px; opacity: 0.7;">Analizados</small>`;
  document.getElementById('tipoMasFrecuente').style.fontSize = '18px';
  
  if (modeloInfo && modeloInfo.metricas_agregadas) {
    const precision = 100 - modeloInfo.metricas_agregadas.denuncias.mae_promedio * 2;
    document.getElementById('confianzaModelo').textContent = `${Math.round(precision)}%`;
  }
  
  if (chartDenuncias) chartDenuncias.destroy();
  
  chartDenuncias = new Chart(document.getElementById('chartDenuncias'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Denuncias Totales',
          data: totalDenPorMes,
          borderColor: 'rgba(74, 144, 226, 1)',
          backgroundColor: 'rgba(74, 144, 226, 0.2)',
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: 'rgba(74, 144, 226, 1)'
        },
        {
          label: 'Emergencias Totales',
          data: totalEmePorMes,
          borderColor: 'rgba(244, 67, 54, 1)',
          backgroundColor: 'rgba(244, 67, 54, 0.2)',
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: 'rgba(244, 67, 54, 1)'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        title: {
          display: true,
          text: 'Evoluci√≥n Temporal de Incidencias',
          font: { size: 16, weight: 'bold' }
        },
        subtitle: {
          display: true,
          text: `Predicci√≥n para ${data.length} meses consecutivos`,
          font: { size: 13 },
          padding: { bottom: 10 }
        },
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              const label = context.dataset.label || '';
              const value = context.parsed.y;
              return `${label}: ${value} casos`;
            },
            afterLabel: function(context) {
              const idx = context.dataIndex;
              if (idx > 0) {
                const prev = context.dataset.data[idx - 1];
                const current = context.parsed.y;
                const diff = current - prev;
                const percent = ((diff / prev) * 100).toFixed(1);
                return `Cambio: ${diff > 0 ? '+' : ''}${diff} (${percent}%)`;
              }
              return '';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            precision: 0,
            callback: function(value) {
              return value + ' casos';
            }
          },
          title: {
            display: true,
            text: 'Cantidad de Incidencias'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Per√≠odo'
          }
        }
      }
    }
  });

  // Tabla de resumen
  let tablaHTML = `
    <div style="background: var(--card-bg-light); padding: 20px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 8px var(--shadow-light);">
      <h3 style="margin-top: 0;">üìä Resumen Estad√≠stico del Rango Predicho</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: rgba(74, 144, 226, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid rgba(74, 144, 226, 1);">
          <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">DENUNCIAS</div>
          <div style="font-size: 24px; font-weight: bold;">${avgDen}</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Promedio mensual</div>
          <div style="font-size: 11px; opacity: 0.6; margin-top: 5px;">Rango: ${minDen} - ${maxDen}</div>
        </div>
        <div style="background: rgba(244, 67, 54, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid rgba(244, 67, 54, 1);">
          <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">EMERGENCIAS</div>
          <div style="font-size: 24px; font-weight: bold;">${avgEme}</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Promedio mensual</div>
          <div style="font-size: 11px; opacity: 0.6; margin-top: 5px;">Rango: ${minEme} - ${maxEme}</div>
        </div>
        <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid rgba(255, 193, 7, 1);">
          <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">MES PICO (DEN)</div>
          <div style="font-size: 18px; font-weight: bold;">${labels[totalDenPorMes.indexOf(maxDen)]}</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">${maxDen} casos</div>
        </div>
        <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid rgba(76, 175, 80, 1);">
          <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">MES M√ÅS BAJO (DEN)</div>
          <div style="font-size: 18px; font-weight: bold;">${labels[totalDenPorMes.indexOf(minDen)]}</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">${minDen} casos</div>
        </div>
      </div>
      
      <h4>Detalle Mensual</h4>
      <div style="overflow-x: auto;">
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Mes</th>
              <th>Denuncias</th>
              <th>Emergencias</th>
              <th>Total</th>
              <th>Cambio vs Mes Anterior</th>
            </tr>
          </thead>
          <tbody>
  `;
  
  data.forEach((mes, idx) => {
    const totalMes = totalDenPorMes[idx] + totalEmePorMes[idx];
    const cambio = idx > 0 ? totalMes - (totalDenPorMes[idx-1] + totalEmePorMes[idx-1]) : 0;
    const cambioColor = cambio > 0 ? 'color: #f44336' : cambio < 0 ? 'color: #4caf50' : '';
    const flecha = cambio > 0 ? '‚ñ≤' : cambio < 0 ? '‚ñº' : '‚Äî';
    
    tablaHTML += `
      <tr>
        <td><strong>${mes.fecha_prediccion}</strong></td>
        <td style="text-align: center;">${totalDenPorMes[idx]}</td>
        <td style="text-align: center;">${totalEmePorMes[idx]}</td>
        <td style="text-align: center;"><strong>${totalMes}</strong></td>
        <td style="text-align: center; ${cambioColor}">
          ${idx > 0 ? `${flecha} ${cambio > 0 ? '+' : ''}${cambio}` : '‚Äî'}
        </td>
      </tr>
    `;
  });
  
  tablaHTML += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  // Gr√°fico de barras apiladas
  const tiposTop = {};
  data.forEach(mes => {
    Object.entries(mes.denuncias).forEach(([tipo, valor]) => {
      if (!tiposTop[tipo]) tiposTop[tipo] = 0;
      tiposTop[tipo] += valor;
    });
  });
  
  const tiposOrdenados = Object.entries(tiposTop)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 6)
    .map(([tipo]) => tipo);
  
  const datasets = tiposOrdenados.map((tipo, idx) => ({
    label: DENUNCIAS_MAP[tipo] || `Tipo ${tipo}`,
    data: data.map(d => d.denuncias[tipo] || 0),
    backgroundColor: `hsla(${idx * 60}, 70%, 60%, 0.8)`,
    borderColor: `hsla(${idx * 60}, 70%, 50%, 1)`,
    borderWidth: 1
  }));

  if (chartEmergencias) chartEmergencias.destroy();
  
  chartEmergencias = new Chart(document.getElementById('chartEmergencias'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        title: {
          display: true,
          text: 'Top 6 Tipos de Denuncia - Distribuci√≥n Mensual',
          font: { size: 16, weight: 'bold' }
        },
        subtitle: {
          display: true,
          text: 'Barras apiladas muestran la composici√≥n de cada mes',
          font: { size: 13 }
        },
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            padding: 8,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            footer: function(items) {
              const total = items.reduce((sum, item) => sum + item.parsed.y, 0);
              return `Total del mes: ${total} casos`;
            }
          }
        }
      },
      scales: {
        x: { 
          stacked: true,
          title: {
            display: true,
            text: 'Per√≠odo'
          }
        },
        y: { 
          stacked: true,
          beginAtZero: true,
          ticks: { 
            precision: 0,
            callback: function(value) {
              return value + ' casos';
            }
          },
          title: {
            display: true,
            text: 'Cantidad Acumulada'
          }
        }
      }
    }
  });

  document.getElementById('chartEmergencias').parentElement.insertAdjacentHTML('beforebegin', tablaHTML);

  document.getElementById('resultadoPrediccion').scrollIntoView({ 
    behavior: 'smooth', 
    block: 'nearest' 
  });
}

async function cargarMetricas() {
  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/info`);
    const data = await response.json();

    if (data.success) {
      const info = data.data;
      
      // Verificar que existen los datos necesarios
      if (!info.calidad_global || !info.metricas_agregadas) {
        console.warn('Estructura de datos incompleta:', info);
        return;
      }
      
      // Actualizar cards de calidad con explicaciones
      const scoreDen = info.calidad_global.denuncias.score;
      const scoreEme = info.calidad_global.emergencias.score;
      
      // Calcular precisi√≥n m√°s comprensible (100 - error%)
      const precisionDen = Math.max(0, 100 - info.metricas_agregadas.denuncias.mae_promedio * 2);
      const precisionEme = Math.max(0, 100 - info.metricas_agregadas.emergencias.mae_promedio * 2);
      
      document.getElementById('scoreDenuncias').textContent = `${Math.round(precisionDen)}%`;
      document.getElementById('scoreEmergencias').textContent = `${Math.round(precisionEme)}%`;
      
      // Niveles comprensibles
      let nivelDen = precisionDen >= 90 ? 'Excelente' : precisionDen >= 80 ? 'Muy Bueno' : precisionDen >= 70 ? 'Bueno' : 'Aceptable';
      let nivelEme = precisionEme >= 90 ? 'Excelente' : precisionEme >= 80 ? 'Muy Bueno' : precisionEme >= 70 ? 'Bueno' : 'Aceptable';
      
      document.getElementById('nivelDenuncias').textContent = nivelDen;
      document.getElementById('nivelEmergencias').textContent = nivelEme;
      document.getElementById('progressDenuncias').style.width = `${precisionDen}%`;
      document.getElementById('progressEmergencias').style.width = `${precisionEme}%`;
      
      // MAE con contexto
      document.getElementById('maeDenuncias').textContent = `¬±${info.metricas_agregadas.denuncias.mae_promedio.toFixed(1)}`;
      document.getElementById('maeEmergencias').textContent = `¬±${info.metricas_agregadas.emergencias.mae_promedio.toFixed(1)}`;
      
      // Verificar que precision_por_tipo existe
      if (!info.precision_por_tipo || !info.precision_por_tipo.denuncias) {
        console.warn('precision_por_tipo no disponible');
        return;
      }
      
      // Gr√°fico de m√©tricas por tipo CON NOMBRES
      const precisionPorTipoDen = Object.entries(info.precision_por_tipo.denuncias).map(([id, data]) => ({
        nombre: DENUNCIAS_MAP[id] || `Tipo ${id}`,
        precision: data.precision_porcentaje,
        mae: data.mae
      })).sort((a, b) => b.precision - a.precision);
      
      
      
      const labels = precisionPorTipoDen.map(d => d.nombre);
      const precisionValues = precisionPorTipoDen.map(d => d.precision);
      
      // Colores seg√∫n nivel de precisi√≥n
      const colores = precisionValues.map(p => {
        if (p >= 90) return 'rgba(76, 175, 80, 0.8)'; // Verde - Excelente
        if (p >= 80) return 'rgba(139, 195, 74, 0.8)'; // Verde claro - Muy bueno
        if (p >= 70) return 'rgba(255, 193, 7, 0.8)'; // Amarillo - Bueno
        return 'rgba(255, 152, 0, 0.8)'; // Naranja - Mejorable
      });
      
      if (chartMetricas) chartMetricas.destroy();
      
      chartMetricas = new Chart(document.getElementById('chartMetricas'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Precisi√≥n del Modelo (%)',
            data: precisionValues,
            backgroundColor: colores,
            borderColor: colores.map(c => c.replace('0.8', '1')),
            borderWidth: 2
          }]
        },
        options: {
          indexAxis: 'y', // Barras horizontales
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Precisi√≥n por Tipo de Denuncia (mayor es mejor)',
              font: { size: 14, weight: 'bold' }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Precisi√≥n: ${context.parsed.x.toFixed(1)}% (${context.parsed.x >= 90 ? 'Excelente' : context.parsed.x >= 80 ? 'Muy Bueno' : 'Bueno'})`;
                }
              }
            }
          },
          scales: {
            x: {
              min: 0,
              max: 100,
              title: {
                display: true,
                text: 'Porcentaje de Precisi√≥n (%)'
              },
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            y: {
              ticks: {
                font: { size: 11 }
              }
            }
          }
        }
      });
      
      // Recomendaciones en lenguaje simple
      const recHtml = info.recomendaciones.map(rec => {
        const iconos = {
          'success': '‚úÖ',
          'warning': '‚ö†Ô∏è',
          'info': '‚ÑπÔ∏è',
          'tip': 'üí°'
        };
        const clase = rec.tipo === 'warning' ? 'alert-warning' : 
                      rec.tipo === 'success' ? 'alert-success' : 'alert-warning';
        
        return `
          <div class="alert ${clase}" style="margin-bottom: 10px;">
            <span>${iconos[rec.tipo]}</span>
            <div>
              <strong>${rec.mensaje}</strong><br>
              <small style="opacity: 0.8;">${rec.accion}</small>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('listaRecomendaciones').innerHTML = recHtml;
      
      // Actualizar info de configuraci√≥n
      if (info.datos) {
        document.getElementById('infoPeriodoDatos').textContent = info.datos.denuncias.periodo_datos;
      }
    }
  } catch (error) {
    console.error('Error cargando m√©tricas:', error);
  }
}

async function compararAnos() {
  const mes = parseInt(document.getElementById('mesComparacion').value);
  const anos = [2027, 2028, 2029, 2030];
  
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Comparando...';

  try {
    const predicciones = await Promise.all(
      anos.map(year => 
        fetch(`${API_URL}/api/modelo/prediccion/predecir`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year, month: mes })
        }).then(r => r.json())
      )
    );

    const datos = predicciones.filter(p => p.success).map(p => p.data);
    
    if (datos.length > 0) {
      mostrarComparacion(datos, mes);
    } else {
      alert('No se pudieron obtener las predicciones');
    }
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîÑ Comparar entre A√±os';
  }
}

function mostrarComparacion(datos, mes) {
  document.getElementById('resultadoComparacion').style.display = 'block';
  
  const mesesNombre = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  
  const labels = datos.map(d => d.year.toString());
  
  // Calcular totales por a√±o
  const totalDenuncias = datos.map(d => Object.values(d.denuncias).reduce((a, b) => a + b, 0));
  const totalEmergencias = datos.map(d => Object.values(d.emergencias).reduce((a, b) => a + b, 0));
  
  // Gr√°fico de l√≠nea con contexto
  if (chartComparacion) chartComparacion.destroy();
  
  chartComparacion = new Chart(document.getElementById('chartComparacion'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Denuncias Totales',
          data: totalDenuncias,
          borderColor: 'rgba(74, 144, 226, 1)',
          backgroundColor: 'rgba(74, 144, 226, 0.2)',
          fill: true,
          tension: 0.4,
          pointRadius: 6,
          pointHoverRadius: 8
        },
        {
          label: 'Emergencias Totales',
          data: totalEmergencias,
          borderColor: 'rgba(244, 67, 54, 1)',
          backgroundColor: 'rgba(244, 67, 54, 0.2)',
          fill: true,
          tension: 0.4,
          pointRadius: 6,
          pointHoverRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        title: {
          display: true,
          text: `Comparaci√≥n de ${mesesNombre[mes]} entre Diferentes A√±os`,
          font: { size: 16, weight: 'bold' }
        },
        subtitle: {
          display: true,
          text: 'C√≥mo cambian las incidencias del mismo mes a lo largo de los a√±os',
          font: { size: 13 },
          padding: { bottom: 10 }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.parsed.y} casos`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            precision: 0,
            callback: function(value) {
              return value + ' casos';
            }
          },
          title: {
            display: true,
            text: 'Cantidad de Incidencias'
          }
        },
        x: {
          title: {
            display: true,
            text: 'A√±o'
          }
        }
      }
    }
  });
  
  // Tabla comparativa mejorada
  let tableHTML = `
    <thead>
      <tr>
        <th>A√±o</th>
        <th>Denuncias<br><small style="opacity: 0.7;">Total del mes</small></th>
        <th>Emergencias<br><small style="opacity: 0.7;">Total del mes</small></th>
        <th>Cambio vs A√±o Anterior<br><small style="opacity: 0.7;">Denuncias</small></th>
        <th>Cambio vs A√±o Anterior<br><small style="opacity: 0.7;">Emergencias</small></th>
      </tr>
    </thead>
    <tbody>
  `;
  
  datos.forEach((d, idx) => {
    const varDen = idx > 0 ? totalDenuncias[idx] - totalDenuncias[idx - 1] : 0;
    const varEme = idx > 0 ? totalEmergencias[idx] - totalEmergencias[idx - 1] : 0;
    const varDenColor = varDen > 0 ? 'color: #f44336; font-weight: bold;' : varDen < 0 ? 'color: #4caf50; font-weight: bold;' : '';
    const varEmeColor = varEme > 0 ? 'color: #f44336; font-weight: bold;' : varEme < 0 ? 'color: #4caf50; font-weight: bold;' : '';
    
    const flechaDen = varDen > 0 ? '‚ñ≤' : varDen < 0 ? '‚ñº' : '‚Äî';
    const flechaEme = varEme > 0 ? '‚ñ≤' : varEme < 0 ? '‚ñº' : '‚Äî';
    
    tableHTML += `
      <tr>
        <td><strong>${d.year}</strong></td>
        <td style="text-align: center;"><strong>${totalDenuncias[idx]}</strong></td>
        <td style="text-align: center;"><strong>${totalEmergencias[idx]}</strong></td>
        <td style="text-align: center; ${varDenColor}">
          ${idx > 0 ? `${flechaDen} ${varDen > 0 ? '+' : ''}${varDen}` : '‚Äî'}
          ${idx > 0 ? `<br><small style="opacity: 0.7;">(${varDen > 0 ? '+' : ''}${((varDen / totalDenuncias[idx-1]) * 100).toFixed(1)}%)</small>` : ''}
        </td>
        <td style="text-align: center; ${varEmeColor}">
          ${idx > 0 ? `${flechaEme} ${varEme > 0 ? '+' : ''}${varEme}` : '‚Äî'}
          ${idx > 0 ? `<br><small style="opacity: 0.7;">(${varEme > 0 ? '+' : ''}${((varEme / totalEmergencias[idx-1]) * 100).toFixed(1)}%)</small>` : ''}
        </td>
      </tr>
    `;
  });
  
  tableHTML += '</tbody>';
  document.getElementById('tablaComparacion').innerHTML = tableHTML;
  
  // A√±adir interpretaci√≥n
  const tendenciaDen = totalDenuncias[totalDenuncias.length - 1] > totalDenuncias[0];
  const tendenciaEme = totalEmergencias[totalEmergencias.length - 1] > totalEmergencias[0];
  
  const interpretacion = `
    <div class="alert ${tendenciaDen || tendenciaEme ? 'alert-warning' : 'alert-success'}" style="margin-top: 20px;">
      <span>${tendenciaDen || tendenciaEme ? 'üìà' : 'üìâ'}</span>
      <div>
        <strong>Interpretaci√≥n de Tendencias:</strong><br>
        <small>
          ${tendenciaDen ? 
            `Las denuncias en ${mesesNombre[mes]} est√°n <strong>aumentando</strong> con el tiempo. Considere asignar m√°s recursos.` : 
            `Las denuncias en ${mesesNombre[mes]} se mantienen <strong>estables o en descenso</strong>.`}
          <br>
          ${tendenciaEme ? 
            `Las emergencias en ${mesesNombre[mes]} est√°n <strong>aumentando</strong> con el tiempo. Reforzar servicios de emergencia.` : 
            `Las emergencias en ${mesesNombre[mes]} se mantienen <strong>estables o en descenso</strong>.`}
        </small>
      </div>
    </div>
  `;
  
  document.getElementById('tablaComparacion').insertAdjacentHTML('afterend', interpretacion);
  
  document.getElementById('resultadoComparacion').scrollIntoView({ 
    behavior: 'smooth', 
    block: 'nearest' 
  });
}

async function reentrenarModelo() {
  if (!confirm('¬øEst√°s seguro de reentrenar el modelo? Este proceso puede tomar 5-10 minutos.')) {
    return;
  }
  
  const btn = event.target;
  btn.disabled = true;
  document.getElementById('entrenamientoProgress').style.display = 'block';

  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/entrenar`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úÖ Modelo reentrenado exitosamente!\n\nTipos de denuncias: ${data.tipos_denuncias}\nTipos de emergencias: ${data.tipos_emergencias}`);
      location.reload(); // Recargar para actualizar m√©tricas
    } else {
      alert('Error: ' + data.error);
    }
  } catch (error) {
    alert('Error de conexi√≥n: ' + error.message);
  } finally {
    btn.disabled = false;
    document.getElementById('entrenamientoProgress').style.display = 'none';
  }
}

// Detectar modo oscuro del sistema
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.body.classList.add('dark');
}

// ==========================================
// NUEVAS FUNCIONALIDADES
// ==========================================

let chartAnalisis, chartRecursos;
let datosHistoricos = null;

// An√°lisis Hist√≥rico
async function generarAnalisisHistorico() {
  const tipo = document.getElementById('tipoAnalisis').value;
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Generando...';

  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/info`);
    const data = await response.json();

    if (data.success) {
      datosHistoricos = data.data.estadisticas_historicas.denuncias;
      
      switch(tipo) {
        case 'tendencia':
          mostrarTendenciaAnual(datosHistoricos);
          break;
        case 'estacionalidad':
          mostrarEstacionalidad(datosHistoricos);
          break;
        case 'dia_semana':
          mostrarDistribucionDiaSemana();
          break;
        case 'correlacion':
          mostrarCorrelacion(datosHistoricos);
          break;
      }

      document.getElementById('resultadoAnalisis').style.display = 'block';
    }
  } catch (error) {
    alert('Error al generar an√°lisis: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üìà Generar An√°lisis';
  }
}

function mostrarTendenciaAnual(datos) {
  document.getElementById('tituloAnalisis').textContent = 'Tendencia Anual - Promedio de Incidencias por Tipo';
  
  const tipos = Object.keys(datos);
  const promedios = tipos.map(t => datos[t].promedio);
  
  if (chartAnalisis) chartAnalisis.destroy();
  
  chartAnalisis = new Chart(document.getElementById('chartAnalisis'), {
    type: 'bar',
    data: {
      labels: tipos.map(t => DENUNCIAS_MAP[t] || `Tipo ${t}`),
      datasets: [{
        label: 'Promedio Hist√≥rico (casos/mes)',
        data: promedios,
        backgroundColor: promedios.map(p => 
          p > 150 ? 'rgba(244, 67, 54, 0.7)' : 
          p > 100 ? 'rgba(255, 152, 0, 0.7)' : 
          'rgba(76, 175, 80, 0.7)'
        ),
        borderWidth: 2
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const datos_tipo = datos[tipos[context.dataIndex]];
              return [
                `Promedio: ${context.parsed.x.toFixed(1)} casos/mes`,
                `M√°ximo: ${datos_tipo.maximo} casos`,
                `M√≠nimo: ${datos_tipo.minimo} casos`,
                `Desviaci√≥n: ¬±${datos_tipo.desviacion.toFixed(1)}`
              ];
            }
          }
        }
      }
    }
  });

  // Insights
  const maxTipo = tipos.reduce((max, t) => datos[t].promedio > datos[max].promedio ? t : max, tipos[0]);
  const minTipo = tipos.reduce((min, t) => datos[t].promedio < datos[min].promedio ? t : min, tipos[0]);
  
  document.getElementById('listaInsights').innerHTML = `
    <div class="alert alert-warning">
      <span>üìä</span>
      <div>
        <strong>Tipo m√°s frecuente:</strong> ${DENUNCIAS_MAP[maxTipo]} con ${datos[maxTipo].promedio.toFixed(0)} casos/mes en promedio<br>
        <strong>Tipo menos frecuente:</strong> ${DENUNCIAS_MAP[minTipo]} con ${datos[minTipo].promedio.toFixed(0)} casos/mes en promedio
      </div>
    </div>
  `;
}

function mostrarEstacionalidad(datos) {
  document.getElementById('tituloAnalisis').textContent = 'Patr√≥n Estacional - Desviaci√≥n Est√°ndar por Tipo';
  
  const tipos = Object.keys(datos);
  const desviaciones = tipos.map(t => datos[t].desviacion);
  
  if (chartAnalisis) chartAnalisis.destroy();
  
  chartAnalisis = new Chart(document.getElementById('chartAnalisis'), {
    type: 'line',
    data: {
      labels: tipos.map(t => DENUNCIAS_MAP[t] || `Tipo ${t}`),
      datasets: [{
        label: 'Variabilidad (desviaci√≥n est√°ndar)',
        data: desviaciones,
        borderColor: 'rgba(74, 144, 226, 1)',
        backgroundColor: 'rgba(74, 144, 226, 0.2)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            afterLabel: function(context) {
              const datos_tipo = datos[tipos[context.dataIndex]];
              const cv = (datos_tipo.desviacion / datos_tipo.promedio * 100).toFixed(1);
              return `Coeficiente de variaci√≥n: ${cv}%`;
            }
          }
        }
      }
    }
  });

  const altaVariabilidad = tipos.filter(t => datos[t].desviacion > 40);
  document.getElementById('listaInsights').innerHTML = `
    <div class="alert alert-warning">
      <span>üìà</span>
      <div>
        <strong>Tipos con alta variabilidad estacional:</strong><br>
        ${altaVariabilidad.map(t => `‚Ä¢ ${DENUNCIAS_MAP[t]}: ¬±${datos[t].desviacion.toFixed(0)} casos`).join('<br>')}
        <br><br><small>Alta variabilidad indica que estos tipos fluct√∫an mucho entre meses</small>
      </div>
    </div>
  `;
}

function mostrarDistribucionDiaSemana() {
  document.getElementById('tituloAnalisis').textContent = 'Distribuci√≥n por D√≠a de Semana (Estimado)';
  
  // Simulaci√≥n basada en patrones comunes
  const dias = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
  const valores = [18, 17, 16, 17, 19, 22, 24]; // M√°s casos en fin de semana
  
  if (chartAnalisis) chartAnalisis.destroy();
  
  chartAnalisis = new Chart(document.getElementById('chartAnalisis'), {
    type: 'radar',
    data: {
      labels: dias,
      datasets: [{
        label: 'Distribuci√≥n Relativa (%)',
        data: valores,
        backgroundColor: 'rgba(74, 144, 226, 0.2)',
        borderColor: 'rgba(74, 144, 226, 1)',
        pointBackgroundColor: 'rgba(74, 144, 226, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 30
        }
      }
    }
  });

  document.getElementById('listaInsights').innerHTML = `
    <div class="alert alert-success">
      <span>üìÖ</span>
      <div>
        <strong>Patr√≥n Identificado:</strong> Los fines de semana (s√°bado y domingo) tienen aproximadamente 25% m√°s incidencias que entre semana.
        <br><br><small>Considere reforzar personal de guardia los fines de semana</small>
      </div>
    </div>
  `;
}

function mostrarCorrelacion(datos) {
  document.getElementById('tituloAnalisis').textContent = 'Correlaci√≥n: Promedio vs Variabilidad';
  
  const tipos = Object.keys(datos);
  const puntos = tipos.map(t => ({
    x: datos[t].promedio,
    y: datos[t].desviacion,
    label: DENUNCIAS_MAP[t] || `Tipo ${t}`
  }));
  
  if (chartAnalisis) chartAnalisis.destroy();
  
  chartAnalisis = new Chart(document.getElementById('chartAnalisis'), {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Tipos de Denuncia',
        data: puntos,
        backgroundColor: 'rgba(74, 144, 226, 0.6)',
        borderColor: 'rgba(74, 144, 226, 1)',
        pointRadius: 8,
        pointHoverRadius: 10
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return [
                context.raw.label,
                `Promedio: ${context.parsed.x.toFixed(1)} casos`,
                `Desviaci√≥n: ${context.parsed.y.toFixed(1)}`
              ];
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Promedio de Casos por Mes' }
        },
        y: {
          title: { display: true, text: 'Desviaci√≥n Est√°ndar' }
        }
      }
    }
  });

  document.getElementById('listaInsights').innerHTML = `
    <div class="alert alert-warning">
      <span>üîç</span>
      <div>
        <strong>Correlaci√≥n Detectada:</strong> Los tipos con mayor promedio tienden a tener mayor variabilidad.
        <br><br><small>Esto es normal: m√°s casos = m√°s fluctuaci√≥n natural</small>
      </div>
    </div>
  `;
}

// Calcular Recursos
async function calcularRecursos() {
  const mesPlan = document.getElementById('mesPlanificacion').value;
  
  if (!mesPlan) {
    alert('Seleccione un mes para planificar');
    return;
  }

  const [year, month] = mesPlan.split('-');
  
  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/predecir`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ year: parseInt(year), month: parseInt(month) })
    });

    const data = await response.json();

    if (data.success) {
      mostrarPlanRecursos(data.data);
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

function mostrarPlanRecursos(prediccion) {
  document.getElementById('resultadoRecursos').style.display = 'block';
  
  const totalCasos = Object.values(prediccion.denuncias).reduce((a, b) => a + b, 0);
  const totalEmergencias = Object.values(prediccion.emergencias).reduce((a, b) => a + b, 0);
  const total = totalCasos + totalEmergencias;
  
  // C√°lculos
  const personal = Math.ceil(totalCasos / 10);
  const vehiculos = Math.ceil(totalEmergencias / 20);
  const presupuesto = (total * 50).toLocaleString('es-PE');
  const horas = (total * 2).toLocaleString('es-PE');
  
  document.getElementById('personalRequerido').textContent = personal;
  document.getElementById('vehiculosNecesarios').textContent = vehiculos;
  document.getElementById('presupuestoEstimado').textContent = `S/ ${presupuesto}`;
  document.getElementById('horasTrabajo').textContent = horas;
  
  // Gr√°fico de recursos por tipo
  const tipos = Object.entries(prediccion.denuncias)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 8);
  
  if (chartRecursos) chartRecursos.destroy();
  
  chartRecursos = new Chart(document.getElementById('chartRecursos'), {
    type: 'doughnut',
    data: {
      labels: tipos.map(([id]) => DENUNCIAS_MAP[id]),
      datasets: [{
        data: tipos.map(([, val]) => val),
        backgroundColor: [
          'rgba(244, 67, 54, 0.8)',
          'rgba(233, 30, 99, 0.8)',
          'rgba(156, 39, 176, 0.8)',
          'rgba(103, 58, 183, 0.8)',
          'rgba(63, 81, 181, 0.8)',
          'rgba(33, 150, 243, 0.8)',
          'rgba(0, 188, 212, 0.8)',
          'rgba(0, 150, 136, 0.8)'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const percent = ((context.parsed / totalCasos) * 100).toFixed(1);
              return `${context.label}: ${context.parsed} casos (${percent}%)`;
            }
          }
        }
      }
    }
  });
  
  // Plan de acci√≥n
  const prioridades = tipos.slice(0, 3);
  document.getElementById('planAccion').innerHTML = `
    <h4>Prioridades para ${prediccion.fecha_prediccion}</h4>
    <ol style="line-height: 2;">
      ${prioridades.map(([id, casos]) => `
        <li><strong>${DENUNCIAS_MAP[id]}</strong>: ${casos} casos esperados
          <br><small style="opacity: 0.7;">‚Üí Asignar ${Math.ceil(casos/10)} personas dedicadas</small>
        </li>
      `).join('')}
    </ol>
    
    <div class="alert alert-success" style="margin-top: 15px;">
      <span>‚úÖ</span>
      <div>
        <strong>Recomendaci√≥n General:</strong> Considere contratar ${personal} personas y preparar ${vehiculos} veh√≠culos para el mes seleccionado.
      </div>
    </div>
  `;
}

// Exportar datos
// Barra de progreso
// ==========================================
// FUNCIONES DE EXPORTACI√ìN ACTUALIZADAS
// ==========================================

// Variables globales para almacenar √∫ltima predicci√≥n
let ultimaPrediccion = null;

// Actualizar cuando se hace una predicci√≥n exitosa
function guardarUltimaPrediccion(year, month, data) {
  ultimaPrediccion = {
    year: year,
    month: month,
    fecha: data.fecha_prediccion,
    denuncias: data.denuncias,
    emergencias: data.emergencias,
    totalDenuncias: Object.values(data.denuncias).reduce((a, b) => a + b, 0),
    totalEmergencias: Object.values(data.emergencias).reduce((a, b) => a + b, 0)
  };
  
  // Calcular tipo m√°s frecuente
  const maxDen = Math.max(...Object.values(data.denuncias));
  const tipoMaxId = Object.keys(data.denuncias).find(k => data.denuncias[k] === maxDen);
  ultimaPrediccion.tipoMasFrecuente = DENUNCIAS_MAP[tipoMaxId] || `Tipo ${tipoMaxId}`;
  
  if (modeloInfo) {
    const precision = 100 - modeloInfo.metricas_agregadas.denuncias.mae_promedio * 2;
    ultimaPrediccion.confianzaModelo = `${Math.round(precision)}%`;
  }
}

// Modificar funci√≥n predecirMes para guardar datos
async function predecirMes() {
  const year = parseInt(document.getElementById('yearInput').value);
  const month = parseInt(document.getElementById('monthInput').value);
  
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Prediciendo...';

  try {
    const response = await fetch(`${API_URL}/api/modelo/prediccion/predecir`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ year, month })
    });

    const data = await response.json();

    if (data.success) {
      guardarUltimaPrediccion(year, month, data.data);  // NUEVO
      mostrarPrediccion(data.data);
    } else {
      alert('Error: ' + data.error);
    }
  } catch (error) {
    alert('Error de conexi√≥n: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üîÆ Predecir Mes';
  }
}

// Exportaci√≥n simplificada - solo env√≠a par√°metros
async function exportarPrediccion(formato) {
  if (!ultimaPrediccion) {
    alert('Primero realiza una predicci√≥n antes de exportar');
    return;
  }

  showProgress(`Exportando a ${formato.toUpperCase()}...`, 'Generando documento en el servidor');
  const progressTimer = simulateProgress(3000);

  try {
    const payload = {
      year: ultimaPrediccion.year,
      month: ultimaPrediccion.month,
      metricas: document.getElementById('incluirMetricas').checked
    };

    const response = await fetch(`${API_URL}/api/exportar/${formato}`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    clearInterval(progressTimer);
    updateProgress(95);

    if (response.ok) {
      const contentType = response.headers.get('content-type');
      
      if (contentType && contentType.includes('application/json')) {
        const errorData = await response.json();
        hideProgress();
        alert('Error: ' + (errorData.error || 'Error desconocido'));
        return;
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      const extensiones = {
        'excel': 'xlsx',
        'pdf': 'pdf',
        'csv': 'csv',
        'json': 'json'
      };
      
      a.download = `prediccion_${ultimaPrediccion.year}_${ultimaPrediccion.month.toString().padStart(2, '0')}.${extensiones[formato]}`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      updateProgress(100);
      
      // Registrar en historial
      const ahora = new Date().toLocaleString('es-PE');
      const historial = document.getElementById('historialExportaciones');
      const nuevoRegistro = document.createElement('div');
      nuevoRegistro.style.cssText = 'padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 5px; margin-bottom: 10px;';
      nuevoRegistro.innerHTML = `‚úÖ Exportado a ${formato.toUpperCase()} el ${ahora}`;
      historial.insertBefore(nuevoRegistro, historial.firstChild);
      
      // Limitar historial a 5 registros
      while (historial.children.length > 5) {
        historial.removeChild(historial.lastChild);
      }

      setTimeout(hideProgress, 500);
    } else {
      hideProgress();
      try {
        const errorData = await response.json();
        alert('Error al exportar: ' + (errorData.error || response.statusText));
      } catch {
        alert('Error al exportar: ' + response.statusText);
      }
    }
  } catch (error) {
    clearInterval(progressTimer);
    hideProgress();
    alert('Error de conexi√≥n: ' + error.message);
    console.error('Error completo:', error);
  }
}

// Funci√≥n para exportar reporte ejecutivo completo
async function exportarReporteCompleto() {
  if (!ultimaPrediccion) {
    alert('Primero realiza una predicci√≥n antes de exportar el reporte completo');
    return;
  }

  const confirmacion = confirm(
    '¬øDesea generar el Reporte Ejecutivo Completo?\n\n' +
    'Este reporte incluye:\n' +
    '‚Ä¢ Predicciones para 6 meses\n' +
    '‚Ä¢ Todos los gr√°ficos y an√°lisis\n' +
    '‚Ä¢ M√©tricas de calidad detalladas\n' +
    '‚Ä¢ Recomendaciones operativas\n' +
    '‚Ä¢ An√°lisis de tendencias\n\n' +
    'El proceso puede tardar 30-60 segundos.'
  );

  if (!confirmacion) return;

  showProgress('Generando Reporte Ejecutivo Completo...', 'Procesando an√°lisis avanzado (esto puede tardar)');
  const progressTimer = simulateProgress(8000);

  try {
    const payload = {
      year: ultimaPrediccion.year,
      month: ultimaPrediccion.month,
      metricas: true,
      graficos: true,
      analisis: true
    };

    const response = await fetch(`${API_URL}/api/exportar/completo`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    clearInterval(progressTimer);
    updateProgress(95);

    if (response.ok) {
      const contentType = response.headers.get('content-type');
      
      if (contentType && contentType.includes('application/json')) {
        const errorData = await response.json();
        hideProgress();
        alert('Error: ' + (errorData.error || 'Error desconocido'));
        return;
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_completo_${ultimaPrediccion.year}_${ultimaPrediccion.month.toString().padStart(2, '0')}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      updateProgress(100);
      
      // Registrar en historial
      const ahora = new Date().toLocaleString('es-PE');
      const historial = document.getElementById('historialExportaciones');
      const nuevoRegistro = document.createElement('div');
      nuevoRegistro.style.cssText = 'padding: 10px; background: rgba(74, 144, 226, 0.1); border-left: 4px solid #4a90e2; border-radius: 5px; margin-bottom: 10px;';
      nuevoRegistro.innerHTML = `üìä <strong>Reporte Completo</strong> generado el ${ahora}`;
      historial.insertBefore(nuevoRegistro, historial.firstChild);

      setTimeout(() => {
        hideProgress();
        alert('‚úÖ Reporte Ejecutivo Completo generado exitosamente!\n\nEl documento incluye an√°lisis detallado de 6 meses con gr√°ficos y recomendaciones.');
      }, 500);
    } else {
      hideProgress();
      try {
        const errorData = await response.json();
        alert('Error al exportar: ' + (errorData.error || response.statusText));
      } catch {
        alert('Error al exportar: ' + response.statusText);
      }
    }
  } catch (error) {
    clearInterval(progressTimer);
    hideProgress();
    alert('Error de conexi√≥n: ' + error.message);
    console.error('Error completo:', error);
  }
}

// Funci√≥n auxiliar para verificar si hay predicci√≥n disponible
function verificarPrediccionDisponible() {
  if (!ultimaPrediccion) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning';
    alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 400px;';
    alertDiv.innerHTML = `
      <span>‚ö†Ô∏è</span>
      <div>
        <strong>Sin predicci√≥n activa</strong><br>
        <small>Realiza primero una predicci√≥n en la pesta√±a "Predicci√≥n" para poder exportar datos</small>
      </div>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.style.opacity = '0';
      alertDiv.style.transition = 'opacity 0.5s';
      setTimeout(() => alertDiv.remove(), 500);
    }, 4000);
    
    return false;
  }
  return true;
}

// A√±adir evento al cambiar a tab de exportaci√≥n
const tabExportarBtn = document.querySelector('[onclick*="exportar"]');
if (tabExportarBtn) {
  tabExportarBtn.addEventListener('click', () => {
    if (!ultimaPrediccion) {
      setTimeout(() => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'alert alert-warning';
        msgDiv.style.marginBottom = '20px';
        msgDiv.innerHTML = `
          <span>‚ÑπÔ∏è</span>
          <div>
            <strong>Informaci√≥n:</strong> No hay ninguna predicci√≥n activa.<br>
            <small>Ve a la pesta√±a "Predicci√≥n" y realiza una predicci√≥n primero. Luego podr√°s exportar los resultados aqu√≠.</small>
          </div>
        `;
        
        const tabExportar = document.getElementById('tab-exportar');
        const controlPanel = tabExportar.querySelector('.control-panel');
        if (controlPanel && !controlPanel.querySelector('.alert')) {
          controlPanel.insertBefore(msgDiv, controlPanel.firstChild);
        }
      }, 100);
    }
  });
}

// Inicializar historial vac√≠o al cargar
document.addEventListener('DOMContentLoaded', () => {
  const historial = document.getElementById('historialExportaciones');
  if (historial && historial.textContent.includes('No hay exportaciones')) {
    // Ya est√° correctamente inicializado
  }
});


// ==========================================
// SISTEMA DE BARRA DE PROGRESO GLOBAL
// ==========================================

let progressModal = null;
let progressBar = null;
let progressMessage = null;

// Mostrar progreso
function showProgress(titulo = "Procesando...", mensaje = "Por favor espere") {
  if (!progressModal) {
    // Crear modal si no existe
    progressModal = document.createElement('div');
    progressModal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); display: flex;
      justify-content: center; align-items: center;
      z-index: 99999; backdrop-filter: blur(2px);
    `;
    progressModal.innerHTML = `
      <div style="background: white; border-radius: 10px; padding: 25px; width: 360px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3)">
        <h3 id="progress-title" style="margin-bottom: 10px;">${titulo}</h3>
        <p id="progress-message" style="font-size: 14px; color: #555;">${mensaje}</p>
        <div style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px;">
          <div id="progress-bar" style="height: 8px; width: 0%; background: #4CAF50; transition: width 0.3s ease;"></div>
        </div>
      </div>
    `;
    document.body.appendChild(progressModal);
    progressBar = document.getElementById('progress-bar');
    progressMessage = document.getElementById('progress-message');
  } else {
    // Actualizar texto si ya existe
    document.getElementById('progress-title').textContent = titulo;
    progressMessage.textContent = mensaje;
    progressBar.style.width = '0%';
    progressModal.style.display = 'flex';
  }
}

// Actualizar barra de progreso
function updateProgress(porcentaje, mensaje = null) {
  if (progressBar) {
    progressBar.style.width = `${porcentaje}%`;
  }
  if (mensaje && progressMessage) {
    progressMessage.textContent = mensaje;
  }
}

// Ocultar progreso
function hideProgress() {
  if (progressModal) {
    progressModal.style.display = 'none';
  }
}

// Simular progreso gradual (para efectos visuales)
function simulateProgress(duracion = 4000) {
  let progreso = 0;
  const interval = setInterval(() => {
    progreso += Math.random() * 10;
    if (progreso >= 90) {
      progreso = 90;
      clearInterval(interval);
    }
    updateProgress(Math.round(progreso));
  }, duracion / 20);
  return interval;
}


// ==========================================
// FIN NUEVAS FUNCIONALIDADES
// ==========================================
</script>

{% endblock %}